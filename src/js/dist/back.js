!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function t(e,t){const n=[];for(const r of t){const t=e[r];t&&n.push(t)}if(t.length<e.length)for(const r of Array.from(new Array(e.length-t.length),(e,n)=>n+t.length))n.push(e[r]);return n}function n(e){const t=[],n=new RegExp("^\\^!!?$"),r=new RegExp("^[^\\^]");for(const[o,s]of e.entries()){const e=[];let c=!1;for(const t of s)n.test(t[2])?c=!0:r.test(t[2])&&e.push(t);t.push({name:o,elements:e,lastMinute:c})}return t}function r(e){const t=[],n=new RegExp("^\\^.*!!(?:[a-zA-Z]+\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z]+)!!?(?:[a-zA-Z]+\\?\\??)?$").exec(r[2])){const o=r[0];0===t.filter(t=>t.name===e[1]).length?t.push({name:e[1],lastMinute:!1,sets:[o]}):t.filter(t=>t.name===e[1])[0].sets.push(o),n.test(r[2])&&(t.filter(t=>t.name===e[1])[0].lastMinute=!0)}}return t}function o(e,t,n){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?t+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?t-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?n-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function s(e){for(var t,n,r=e.length;0!==r;)n=Math.floor(Math.random()*r),t=e[r-=1],e[r]=e[n],e[n]=t;return e}function c(e){return e.map(e=>({name:e.name,length:e.elements.length,order:s([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function i(e,t){return e.map(e=>{const n=e.sets.map(e=>t.filter(t=>t.name===e)).map(e=>e[0].elements.length),r=n.reduce((e,t)=>e+t,0);return{name:e.name,length:r,sets:e.sets,setLengths:n,order:s([...new Array(r).keys()]),lastMinute:e.lastMinute}})}function l(e,n,r,o){const s=e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"])),l=JSON.parse(JSON.stringify(s)),a=[c(e),i(n,e)].flat();return r.forEach(e=>(function(e,t){const n=function(e,t){return e.sets.map(e=>({name:e,length:t.filter(t=>t.name===e)[0].length})).reduce((e,t)=>e.length<t.length?t:e).name}(e,t),r=t.filter(e=>e.name===n)[0].order;for(const n of e.sets){const e=t.filter(e=>e.name===n)[0].order,o=r.filter(t=>t<e.length);t.forEach(e=>{e.name===n&&(e.order=o)})}return t})(e,a)),a.filter(e=>e.lastMinute||!o).forEach(e=>(function(e,n,r){switch(typeof e.name){case"number":const o=r[e.name];n[e.name]=t(o,e.order);break;case"string":(function(e,t){const n=[];let r=0;for(const o of t)n.push(e.slice(r,r+o)),r+=o;return n})(t(e.sets.map(e=>r[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}})(e,l,s)),[l,a]}if(window.Persistence&&Persistence.isAvailable()&&Persistence.getItem("AnkiSetRandomizerOptions")){const t=Persistence.getItem("AnkiSetRandomizerOptions");console.log(t);const s=function(t){let n;const r=function(){if(n)return n;{const r=RegExp(`(?:${e(t.inputSyntax.openDelim)})(.*?)(?:${e(t.inputSyntax.closeDelim)})`,"gm"),o=document.querySelector(t.query),s=o?o.innerHTML:"",c=[];let i=r.exec(s);for(;i;)c.push(i[1]),i=r.exec(s);return n=c}};return{getRawStructure:r,getOriginalStructure:function(){const e=[];for(const[n,o]of r().entries())e.push(o.split(t.inputSyntax.fieldSeparator).map((e,t)=>[n,t,e]));return e},renderSets:function(e){const n=[];for(const r of e){const e=[],o=0;for(const[n,s]of r.entries())if("d"!==s[3]){const r=(o+n)%t.colors.length,c=`style="color: ${t.colors[r]}; padding: 0px ${t.fieldPadding};"`;e.push(`<span ${c}> ${s[2]}</span>`)}n.push(e.join(t.outputSyntax.fieldSeparator))}const o=document.querySelector(t.query);let s=o?o.innerHTML:"";for(const[e,o]of r().entries())s=s.replace(`${t.inputSyntax.openDelim}${o}${t.inputSyntax.closeDelim}`,`${t.outputSyntax.openDelim}${n[e]}${t.outputSyntax.closeDelim}`);document.querySelector(t.query).innerHTML=s}}}(t),c=s.getOriginalStructure();if(c){const e=n(c),t=r(c),i=r(c),[a,u]=l(e,t,i,!1),f=function(e){const t=[],n="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z]+)",r=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?=(?:(\\d+))?$`,s=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?\\~(?:(\\d+))?$`,c=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?%(?:(\\d+))?$`;for(const n of e)for(const i of n){const l=i[0],a=i[1];let u,f;if((u=new RegExp(r,"gm").exec(i[2]))?f="c":(u=new RegExp(s,"gm").exec(i[2]))?f="m":(u=new RegExp(c,"gm").exec(i[2]))&&(f="d"),f){const r=o(u[1],l,e.length),s=o(u[2]||0,a,n.length),c=Number(u[3])||999;t.push([l,a,f,r,s,c])}}return t}(c).reverse();[f.filter(e=>"m"===e[2]),f.filter(e=>"c"===e[2]),f.filter(e=>"d"===e[2])].flat().forEach(e=>(function(e,t){const n=t[e[3]].filter(e=>"n"===e[3]).slice(e[4],e[4]+e[5]);"d"!==e[2]&&"m"!==e[2]||t[e[3]].splice(e[4],e[5],...n.map(e=>[e[0],e[1],e[2],"d"])),"c"!==e[2]&&"m"!==e[2]||t[e[0]].splice(e[1],0,...n.map(t=>[t[0],t[1],t[2],e[2]]))})(e,a));const m=n(a.map(e=>e.filter(e=>"d"!==e[3]))).map((t,n)=>({name:t.name,elements:t.elements,lastMinute:e[n].lastMinute})),[p,g]=l(m,t,i.filter(e=>e.lastMinute),!0);s.renderSets(p)}}}();
