!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}const n="[a-zA-Z_]\\w*";function t(e,t){const o=[],s=[],r=new RegExp(`^\\^(${n})\\[(.*)\\]$`),i=[];for(const[n,t]of e.entries())for(const e of t){let n;(n=e[2].match(r))&&i.push({name:n[1],elements:n[2].substr(1,n[2].length-2).split(new RegExp("['\"],[\"']"))})}const a=new RegExp("^\\^!!?$"),c=`^\\^(?:${n}\\$)?(\\d+(?:\\.\\d*)?,\\d+(?:\\.\\d*)?(?:,\\d+)?|${n})#$`,f=`^\\^(${n})\\$`,l=new RegExp("^[^\\^]"),u=[];for(const[n,r]of e.entries()){const e=[];let p=!1;for(const n of r){let o;if(a.test(n[2]))p=!0;else if(o=new RegExp(c,"gm").exec(n[2])){const r=o[0].match(RegExp(f));let a;r&&(a=r[1]),u.find(e=>e.name===a)||u.push({name:a,values:[]});const c=n[0],l=n[1];let p;const h=t.find(e=>e[0]===c&&e[1]===l);if(h)p=h;else if(/^\d/.test(o[1])){const e=o[1].match(RegExp("(\\d+(?:\\.\\d*)?),(\\d+(?:\\.\\d*)?)(?:,(\\d+))?")),n=e[1],t=e[2],s=e[3],r=n.includes(".")||t.includes(".");let i,f=!1,h=0;const g=1e3;for(;!f&&h<g;){const e=(m=Number(n),d=Number(t),Math.random()*(d-m)+m);i=r?e.toFixed(s||2):(Math.round(e)*(s||1)).toString(),a&&(u.find(e=>e.name===a).values.includes(i)||(f=!0)),h++}h<g&&(p=[c,l,i])}else{const e=o[1],n=i.find(n=>n.name===e);if(n){let e,t=!1,o=0;const s=1e3;for(;!t&&o<s;){const s=Math.floor(Math.random()*n.elements.length);e=n.elements[s],a&&(u.find(e=>e.name===a).values.includes(e)||(t=!0)),o++}o<s&&(p=[c,l,e])}}p&&(a&&u.find(e=>e.name===a).values.push(p[2]),s.push(p),e.push(p))}else l.test(n[2])&&e.push(n)}o.push({name:n,elements:e,lastMinute:p})}var m,d;return[o,s]}function o(e,n,t){let o;return(o=new RegExp("^\\+(\\d+)$").exec(e))?n+Number(o[1]):(o=new RegExp("^-(\\d+)$").exec(e))?n-Number(o[1]):(o=new RegExp("^n(-\\d+)?$").exec(e))?t-(Number(o[1])||0)-1:(o=new RegExp("^\\d+$").exec(e))?Number(e):e}function s(e){for(var n,t,o=e.length;0!==o;)t=Math.floor(Math.random()*o),n=e[o-=1],e[o]=e[t],e[t]=n;return e}function r(e){return e.map(e=>({name:e.name,length:e.elements.length,order:s([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function i(e,n){return e.map(e=>{const t=e.sets.map(e=>n.filter(n=>n.name===e)).map(e=>e[0].elements.length),o=t.reduce((e,n)=>e+n,0);return{name:e.name,length:o,sets:e.sets,setLengths:t,order:s([...new Array(o).keys()]),lastMinute:e.lastMinute}})}function a(e,n){const t=function(e,n){return e.sets.map(e=>({name:e,length:n.find(n=>n.name===e).length})).reduce((e,n)=>e.length<n.length?n:e).name}(e,n),o=n.find(e=>e.name===t).order;for(const t of e.sets){const e=n.find(e=>e.name===t).order,s=o.filter(n=>n<e.length);n.forEach(e=>{e.name===t&&(e.order=s)})}return n}function c(e,n,t){const o=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),s=JSON.parse(JSON.stringify(o)),c=[r(e),i(n,e)].flat();return t.forEach(e=>a(e,c)),[o,s,c]}function f(e,n){if(!n||e.length!==n.length)return!1;for(let t=0,o=e.length;t<o;t++)if(e[t]instanceof Array&&n[t]instanceof Array){if(!f(e[t],n[t]))return!1}else if(e[t]!=n[t])return!1;return!0}function l(e,n){const t=[];let o;for(const[s,r]of n.entries())(o=e.find(e=>e.from===s))&&(t[o.to]=r);return t}function u(e,n){const t=[];for(const n of e)t.push(n);for(const e of n)t.includes(e)||t.push(e);return t}function m(e,n){const t=[];for(const o of n){const n=e[o];n&&t.push(n)}if(n.length<e.length)for(const o of Array.from(new Array(e.length-n.length),(e,t)=>t+n.length))t.push(e[o]);return t}function d(e,n,t){switch(typeof e.name){case"number":const o=t[e.name];n[e.name]=m(o,e.order);break;case"string":(function(e,n){const t=[];let o=0;for(const s of n)t.push(e.slice(o,o+s)),o+=s;return t})(m(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((t,o)=>{n[e.sets[o]]=t})}}function p(e,n,t){const o=[];for(const s of e){let e;"string"==typeof s.name?(e=n.find(e=>s.name===e.name))?o.push({name:s.name,length:s.length,sets:s.sets,setLengths:s.setLengths,order:u(e.order,s.order),lastMinute:s.lastMinute}):o.push(s):(e=t.find(e=>s.name===e.to))?o.push(n.find(n=>n.name===e.from)):o.push(s)}return o}window.Persistence&&Persistence.isAvailable()&&function(){const s=Persistence.getItem("AnkiSetRandomizerOriginalStructure"),r=Persistence.getItem("AnkiSetRandomizerOptions"),i=Persistence.getItem("AnkiSetRandomizerGeneratorValues"),u=Persistence.getItem("AnkiSetRandomizerNewReorders"),m=Persistence.getItem("AnkiSetRandomizerLastMinuteReorders"),h=Persistence.getItem("AnkiSetRandomizerRandomIndices");if(!(s&&r&&i&&u&&m&&h))return;const g=function(n){let t={};const o=`${e(n.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(n.inputSyntax.closeDelim)}`,s=function(e=n.query){if(t[e])return t[e];{const n=document.querySelector(e),s=n?n.innerHTML:"",r=[],i=RegExp(o,"gm");let a=i.exec(s);for(;a;)r.push(a[1]),a=i.exec(s);return t[e]=r}},r=function(e=n.query){const t=[];for(const[o,r]of s(e).entries()){const e=r.split(n.inputSyntax.fieldSeparator).map((e,n)=>[o,n,e]);t.push(e)}return t},i=function(e,t,o,a=n.query){let c=0+(n.colors_random_start_index?Math.floor((o[0]||Math.random())*n.colors.length):0),f=0;const l=Array(e.length);for(const[s,r]of e.entries()){const e=t.find(e=>e.name===s).directives;let i;void 0===e.colors?i=n.colors:(i=e.colors,f=c,c=0);const a=void 0===e.fieldSeparator?n.outputSyntax.fieldSeparator:e.fieldSeparator,u=void 0===e.fieldPadding?n.fieldPadding:e.fieldPadding,m=void 0===e.closeDelim?n.outputSyntax.closeDelim:e.closeDelim,d=void 0===e.openDelim?n.outputSyntax.openDelim:e.openDelim,p=[],h=n.colors_random_start_index?Math.floor((o[s]||Math.random())*i.length):0;for(const[e,t]of r.rendering.entries())if("d"!==t[3]){const o=(n.colors_collective_indexing?c++:h+e)%i.length,s=`class="set-randomizer--element set-randomizer--element-index-${t[0]}-${t[1]}"`,r=`style="padding: 0px ${u}px;${i[o]?` color: ${i[o]};`:""}"`;p.push(`<span ${s} ${r}>${t[2]}</span>`)}p.length>0?l[r.order]=`${d}${p.join(a)}${m}`:l[r.order]=`${d}${n.outputSyntax.emptySet}${m}`,void 0!==e.colors&&(c=f)}const u=document.querySelector(a);let m=u?u.innerHTML:"";for(const[e,t]of s(a).entries()){const o=l[e];m=m.replace(`${n.inputSyntax.openDelim}${t}${n.inputSyntax.closeDelim}`,`${o}`)}if(document.querySelector(a).innerHTML=m,"div#clozed"===a){const n=r("div#original").flat();if(n.length>0){const s=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],n.find(n=>n[0]===e[0]&&n[1]===e[1])[2],e[3]]),order:e.order}));i(s,t,o,"div#original")}}};return{getOriginalStructure:r,renderSets:i}}(r),$=g.getOriginalStructure();if($){const e=function(e,n){const t=[];for(const o of e)for(const e of n)!f(o.map(e=>e[2]),e.map(e=>e[2]))||t.find(n=>n.from===e[0][0])||t.find(e=>e.to===o[0][0])||t.push({from:e[0][0],to:o[0][0]});return t}($,s),[r,x]=t($,function(e,n){const t=[];for(const o of n){const n=e.find(e=>e.from===o[0]);n&&t.push([n.to,o[1],o[2]])}return t}(e,i)),S=function(e){const t=[],o=`${n}\\?\\?`,s=`^\\^(${n})!!?(?:${o}|${`(?:${n}\\+)?(?:([a-zA-Z]+),.*?@)*$`})?$`,r=new RegExp(`^\\^.*!!${o}$`);for(const n of e.flat()){let e;if(e=new RegExp(s).exec(n[2])){const o=n[0];0===t.filter(n=>n.name===e[1]).length?t.push({name:e[1],lastMinute:!1,sets:[o]}):t.filter(n=>n.name===e[1])[0].sets.push(o),r.test(n[2])&&(t.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return t}($),y=function(e){const t=[],o=`^\\^${`(?:(${n})!!?)?`}(${n})\\?$`,s=new RegExp("^\\^.*\\?\\?$");for(const n of e.flat()){let e;if(e=new RegExp(o).exec(n[2])){const o=e[1]||n[0];0===t.filter(n=>n.name===e[2]).length?t.push({name:e[2],sets:[o]}):t.filter(n=>n.name===e[2])[0].sets.push(o),s.test(n[2])&&(t.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return t}($),E=function(e,t){const o=[],s=`^\\^(?:(?:(${n})!)?(${n})\\+)?((?:[a-zA-Z]+,.*?@)*)$`,r=[],i=[];for(const[n,a]of e.entries()){o.push({name:n,directives:{}});for(const e of a){let o;if(o=e[2].match(s)){const e=o[1],s=o[2];s&&(r.find(e=>e.name===s)||r.push({name:s,sets:[]}),e?r.find(e=>e.name===s).sets.push(...t.find(n=>n.name===e).sets):r.find(e=>e.name===s).sets.push(n));const a=o[3].split("@").slice(0,-1);a.length>0&&i.push({name:s||n,assignments:a.map(e=>[e.split(",",1)[0],e.split(/^.*?,/)[1]])})}}}for(const e of i.sort((e,n)=>"number"==typeof e.name?1:-1)){const n=[];for(const t of e.assignments)switch(t[0]){case"openDelim":case"od":n.push({name:"openDelim",value:t[1]});break;case"closeDelim":case"cd":n.push({name:"closeDelim",value:t[1]});break;case"fieldSeparator":case"fs":n.push({name:"fieldSeparator",value:t[1]});break;case"fieldPadding":case"fp":const e=Number(t[1]);e&&n.push({name:"fieldPadding",value:e});break;case"colors":case"clrs":n.push({name:"colors",value:t[1].split(",")})}const t=function(e,n){switch(typeof e){case"number":for(const t of n)o.find(n=>n.name===e).directives[t.name]=t.value;break;case"string":for(const o of r.find(n=>n.name===e).sets)t(o,n)}};t(e.name,n)}return o}($,S);console.log(E);const[M,R,v]=c(r,S,y),w=p(v,u,e);y.forEach(e=>a(e,w)),w.forEach(e=>d(e,M,R));const b=function(e){const n=[],t="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|${namePattern})",s=`^\\^(?:${t}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?=$`,r=`^\\^(?:${t}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\~$`,i=`^\\^(?:${t}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\%$`;for(const t of e)for(const a of t){const c=a[0],f=a[1];let l,u;if((l=new RegExp(s,"gm").exec(a[2]))?u="c":(l=new RegExp(r,"gm").exec(a[2]))?u="m":(l=new RegExp(i,"gm").exec(a[2]))&&(u="d"),u){const s=o(l[1]||c,c,e.length),r=o(l[2]||0,f,t.length),i=Number(l[3])||999;n.push([s,r,i,u,c,f])}}return n}($),A=b.reverse(),k=[A.filter(e=>"c"===e[3]),A.filter(e=>"m"===e[3]),A.filter(e=>"d"===e[3])].flat();k.forEach(e=>(function(e,n){const t=[];for(const o of n[e[0]])if("d"!==o[3]&&"c"!==o[3]&&(t.push(o.map(e=>e)),"d"!==e[3]&&"m"!==e[3]||(o[3]="d"),0==--e[2]))break;t.forEach(e=>e.splice(3,1,"c")),"c"!==e[3]&&"m"!==e[3]||n[e[4]].splice(e[5],0,...t)})(e,M));const D=M.map(e=>e.filter(e=>"d"!==e[3])),P=t(D,[])[0].map((e,n)=>({name:e.name,elements:e.elements,lastMinute:r[n].lastMinute})),z=y.filter(e=>e.lastMinute),[N,_,L]=c(P,S,z),I=p(L,m,e);z.forEach(e=>a(e,I)),I.filter(e=>e.lastMinute).forEach(e=>d(e,N,_)),g.renderSets(N.map((e,n)=>({rendering:e,order:n})),E,l(e,l(e,h)))}}()}();
