!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function t(e,t){const n=[];for(const r of t){const t=e[r];t&&n.push(t)}if(t.length<e.length)for(const r of Array.from(new Array(e.length-t.length),(e,n)=>n+t.length))n.push(e[r]);return n}function n(e){const t=[],n=new RegExp("^\\^!!?$"),r=new RegExp("^[^\\^]");for(const[s,o]of e.entries()){const e=[];let c=!1;for(const t of o)n.test(t[2])?c=!0:r.test(t[2])&&e.push(t);t.push({name:s,elements:e,lastMinute:c})}return t}function r(e){const t=[],n=new RegExp("^\\^.*!!(?:[a-zA-Z]+\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z]+)!!?(?:[a-zA-Z]+\\?\\??)?$").exec(r[2])){const s=r[0];0===t.filter(t=>t.name===e[1]).length?t.push({name:e[1],lastMinute:!1,sets:[s]}):t.filter(t=>t.name===e[1])[0].sets.push(s),n.test(r[2])&&(t.filter(t=>t.name===e[1])[0].lastMinute=!0)}}return t}function s(e,t,n){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?t+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?t-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?n-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function o(e){for(var t,n,r=e.length;0!==r;)n=Math.floor(Math.random()*r),t=e[r-=1],e[r]=e[n],e[n]=t;return e}function c(e){return e.map(e=>({name:e.name,length:e.elements.length,order:o([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function i(e,t){return e.map(e=>{const n=e.sets.map(e=>t.filter(t=>t.name===e)).map(e=>e[0].elements.length),r=n.reduce((e,t)=>e+t,0);return{name:e.name,length:r,sets:e.sets,setLengths:n,order:o([...new Array(r).keys()]),lastMinute:e.lastMinute}})}function a(e,n,r,s){const o=e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"])),a=JSON.parse(JSON.stringify(o)),l=[c(e),i(n,e)].flat();return r.forEach(e=>(function(e,t){const n=function(e,t){return e.sets.map(e=>({name:e,length:t.filter(t=>t.name===e)[0].length})).reduce((e,t)=>e.length<t.length?t:e).name}(e,t),r=t.filter(e=>e.name===n)[0].order;for(const n of e.sets){const e=t.filter(e=>e.name===n)[0].order,s=r.filter(t=>t<e.length);t.forEach(e=>{e.name===n&&(e.order=s)})}return t})(e,l)),l.filter(e=>e.lastMinute||!s).forEach(e=>(function(e,n,r){switch(typeof e.name){case"number":const s=r[e.name];n[e.name]=t(s,e.order);break;case"string":(function(e,t){const n=[];let r=0;for(const s of t)n.push(e.slice(r,r+s)),r+=s;return n})(t(e.sets.map(e=>r[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}})(e,a,o)),[a,l]}if(window.Persistence&&Persistence.isAvailable()&&Persistence.getItem("AnkiSetRandomizerOptions")){const t=function(t){let n;const r=function(){if(n)return n;{const r=document.querySelector(t.query),s=r?r.innerHTML:"",o=[],c=RegExp(`${e(t.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(t.inputSyntax.closeDelim)}`,"gm");let i=c.exec(s);for(;i;)o.push(i[1]),i=c.exec(s);return n=o}};return{getRawStructure:r,getOriginalStructure:function(){const e=[];for(const[n,s]of r().entries()){const r=s.split(t.inputSyntax.fieldSeparator).map((e,t)=>[n,t,e]);e.push(r)}return e},renderSets:function(e){const n=[];for(const r of e){const e=[],s=0;for(const[n,o]of r.entries())if("d"!==o[3]){const r=(s+n)%t.colors.length,c=`style="color: ${t.colors[r]}; padding: 0px ${t.fieldPadding};"`;e.push(`<span ${c}> ${o[2]}</span>`)}n.push(e.join(t.outputSyntax.fieldSeparator))}const s=document.querySelector(t.query);let o=s?s.innerHTML:"";for(const[e,s]of r().entries())o=o.replace(`${t.inputSyntax.openDelim}${s}${t.inputSyntax.closeDelim}`,`${t.outputSyntax.openDelim}${n[e]}${t.outputSyntax.closeDelim}`);document.querySelector(t.query).innerHTML=o}}}(Persistence.getItem("AnkiSetRandomizerOptions")),o=t.getOriginalStructure();if(o){const e=n(o),c=r(o),i=r(o),[l,u]=a(e,c,i,!1),f=function(e){const t=[],n="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z]+)",r=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?=(?:(\\d+))?$`,o=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?\\~(?:(\\d+))?$`,c=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?\\%(?:(\\d+))?$`;for(const n of e)for(const i of n){const a=i[0],l=i[1];let u,f;if((u=new RegExp(r,"gm").exec(i[2]))?f="c":(u=new RegExp(o,"gm").exec(i[2]))?f="m":(u=new RegExp(c,"gm").exec(i[2]))&&(f="d"),f){const r=s(u[1],a,e.length),o=s(u[2]||0,l,n.length),c=Number(u[3])||999;t.push([a,l,f,r,o,c])}}return t}(o).reverse();[f.filter(e=>"m"===e[2]),f.filter(e=>"c"===e[2]),f.filter(e=>"d"===e[2])].flat().forEach(e=>(function(e,t){const n=t[e[3]].filter(e=>"n"===e[3]).slice(e[4],e[4]+e[5]);"d"!==e[2]&&"m"!==e[2]||t[e[3]].splice(e[4],e[5],...n.map(e=>[e[0],e[1],e[2],"d"])),"c"!==e[2]&&"m"!==e[2]||t[e[0]].splice(e[1],0,...n.map(t=>[t[0],t[1],t[2],e[2]]))})(e,l));const m=n(l.map(e=>e.filter(e=>"d"!==e[3]))).map((t,n)=>({name:t.name,elements:t.elements,lastMinute:e[n].lastMinute})),[p,g]=a(m,c,i.filter(e=>e.lastMinute),!0);t.renderSets(p)}}}();
