!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function n(e,n){const t=[],r=[],o=new RegExp("^\\^([a-zA-Z_]\\w*)\\[(.*)\\]$"),s=[];for(const[n,t]of e.entries())for(const e of t){let n;(n=e[2].match(o))&&s.push({name:n[1],elements:n[2].substr(1,n[2].length-2).split(new RegExp("['\"],[\"']"))})}const i=new RegExp("^\\^!!?$"),c=new RegExp("^[^\\^]"),a=[];for(const[o,u]of e.entries()){const e=[];let m=!1;for(const t of u){let o;if(i.test(t[2]))m=!0;else if(o=new RegExp("^\\^(?:[a-zA-Z_]\\w*\\$)?(\\d+(?:\\.\\d*)?,\\d+(?:\\.\\d*)?(?:,\\d+)?|[a-zA-Z_]\\w*)#$","gm").exec(t[2])){const i=o[0].match(RegExp("^\\^([a-zA-Z_]\\w*)\\$"));let c;i&&(c=i[1]),a.find(e=>e.name===c)||a.push({name:c,values:[]});const u=t[0],m=t[1];let d;const p=n.find(e=>e[0]===u&&e[1]===m);if(p)d=p;else if(/^\d/.test(o[1])){const e=o[1].match(RegExp("(\\d+(?:\\.\\d*)?),(\\d+(?:\\.\\d*)?)(?:,(\\d+))?")),n=e[1],t=e[2],r=e[3],s=n.includes(".")||t.includes(".");let i,p=!1,h=0;const g=1e3;for(;!p&&h<g;){const e=(f=Number(n),l=Number(t),Math.random()*(l-f)+f);i=s?e.toFixed(r||2):(Math.round(e)*(r||1)).toString(),c&&(a.find(e=>e.name===c).values.includes(i)||(p=!0)),h++}h<g&&(d=[u,m,i])}else{const e=o[1],n=s.find(n=>n.name===e);if(n){let e,t=!1,r=0;const o=1e3;for(;!t&&r<o;){const o=Math.floor(Math.random()*n.elements.length);e=n.elements[o],c&&(a.find(e=>e.name===c).values.includes(e)||(t=!0)),r++}r<o&&(d=[u,m,e])}}d&&(c&&a.find(e=>e.name===c).values.push(d[2]),r.push(d),e.push(d))}else c.test(t[2])&&e.push(t)}t.push({name:o,elements:e,lastMinute:m})}var f,l;return[t,r]}function t(e,n,t){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?n+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?n-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?t-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function r(e){for(var n,t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),n=e[r-=1],e[r]=e[t],e[t]=n;return e}function o(e){return e.map(e=>({name:e.name,length:e.elements.length,order:r([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function s(e,n){return e.map(e=>{const t=e.sets.map(e=>n.filter(n=>n.name===e)).map(e=>e[0].elements.length),o=t.reduce((e,n)=>e+n,0);return{name:e.name,length:o,sets:e.sets,setLengths:t,order:r([...new Array(o).keys()]),lastMinute:e.lastMinute}})}function i(e,n){const t=function(e,n){return e.sets.map(e=>({name:e,length:n.find(n=>n.name===e).length})).reduce((e,n)=>e.length<n.length?n:e).name}(e,n),r=n.find(e=>e.name===t).order;for(const t of e.sets){const e=n.find(e=>e.name===t).order,o=r.filter(n=>n<e.length);n.forEach(e=>{e.name===t&&(e.order=o)})}return n}function c(e,n,t){const r=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),c=JSON.parse(JSON.stringify(r)),a=[o(e),s(n,e)].flat();return t.forEach(e=>i(e,a)),[r,c,a]}function a(e,n){if(!n||e.length!==n.length)return!1;for(let t=0,r=e.length;t<r;t++)if(e[t]instanceof Array&&n[t]instanceof Array){if(!a(e[t],n[t]))return!1}else if(e[t]!=n[t])return!1;return!0}function f(e,n){const t=[];let r;for(const[o,s]of n.entries())(r=e.find(e=>e.from===o))&&(t[r.to]=s);return t}function l(e,n){const t=[];for(const n of e)t.push(n);for(const e of n)t.includes(e)||t.push(e);return t}function u(e,n){const t=[];for(const r of n){const n=e[r];n&&t.push(n)}if(n.length<e.length)for(const r of Array.from(new Array(e.length-n.length),(e,t)=>t+n.length))t.push(e[r]);return t}function m(e,n,t){switch(typeof e.name){case"number":const r=t[e.name];n[e.name]=u(r,e.order);break;case"string":(function(e,n){const t=[];let r=0;for(const o of n)t.push(e.slice(r,r+o)),r+=o;return t})(u(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}}function d(e,n,t){const r=[];for(const o of e){let e;"string"==typeof o.name?(e=n.find(e=>o.name===e.name))?r.push({name:o.name,length:o.length,sets:o.sets,setLengths:o.setLengths,order:l(e.order,o.order),lastMinute:o.lastMinute}):r.push(o):(e=t.find(e=>o.name===e.to))?r.push(n.find(n=>n.name===e.from)):r.push(o)}return r}window.Persistence&&Persistence.isAvailable()&&function(){const r=Persistence.getItem("AnkiSetRandomizerOriginalStructure"),o=Persistence.getItem("AnkiSetRandomizerOptions"),s=Persistence.getItem("AnkiSetRandomizerGeneratorValues"),l=Persistence.getItem("AnkiSetRandomizerNewReorders"),u=Persistence.getItem("AnkiSetRandomizerLastMinuteReorders"),p=Persistence.getItem("AnkiSetRandomizerRandomIndices");if(!(r&&o&&s&&l&&u&&p))return;const h=function(n){let t={};const r=`${e(n.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(n.inputSyntax.closeDelim)}`,o=function(e=n.query){if(t[e])return t[e];{const n=document.querySelector(e),o=n?n.innerHTML:"",s=[],i=RegExp(r,"gm");let c=i.exec(o);for(;c;)s.push(c[1]),c=i.exec(o);return t[e]=s}},s=function(e=n.query){const t=[];for(const[r,s]of o(e).entries()){const e=s.split(n.inputSyntax.fieldSeparator).map((e,n)=>[r,n,e]);t.push(e)}return t},i=function(e,t,r=n.query){let c=0+(n.colors_random_start_index?Math.floor((t[0]||Math.random())*n.colors.length):0);const a=Array(e.length);for(const[r,o]of e.entries()){const e=[],s=n.colors_random_start_index?Math.floor((t[r]||Math.random())*n.colors.length):0;for(const[t,r]of o.rendering.entries())if("d"!==r[3]){const o=(n.colors_collective_indexing?c++:s+t)%n.colors.length,i=`class="set-randomizer--element set-randomizer--element-index-${r[0]}-${r[1]}"`,a=n.colors[o]?` color: ${n.colors[o]};`:"",f=`style="padding: 0px ${n.fieldPadding}px;${a}"`;e.push(`<span ${i} ${f}>${r[2]}</span>`)}a[o.order]=e.join(n.outputSyntax.fieldSeparator)}const f=document.querySelector(r);let l=f?f.innerHTML:"";for(const[e,t]of o(r).entries()){const r=a[e]||n.outputSyntax.emptySet;l=l.replace(`${n.inputSyntax.openDelim}${t}${n.inputSyntax.closeDelim}`,`${n.outputSyntax.openDelim}${r}${n.outputSyntax.closeDelim}`)}if(document.querySelector(r).innerHTML=l,"div#clozed"===r){const n=s("div#original").flat();if(n.length>0){const r=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],n.find(n=>n[0]===e[0]&&n[1]===e[1])[2],e[3]]),order:e.order}));i(r,t,"div#original")}}};return{getOriginalStructure:s,renderSets:i}}(o),g=h.getOriginalStructure();if(g){const e=function(e,n){const t=[];for(const r of e)for(const e of n)!a(r.map(e=>e[2]),e.map(e=>e[2]))||t.find(n=>n.from===e[0][0])||t.find(e=>e.to===r[0][0])||t.push({from:e[0][0],to:r[0][0]});return t}(g,r),[o,x]=n(g,function(e,n){const t=[];for(const r of n){const n=e.find(e=>e.from===r[0]);n&&t.push([n.to,r[1],r[2]])}return t}(e,s)),$=function(e){const n=[],t=new RegExp("^\\^.*!!(?:[a-zA-Z_]\\w*\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z_]\\w*)!!?(?:[a-zA-Z_]\\w*\\?\\??)?$").exec(r[2])){const o=r[0];0===n.filter(n=>n.name===e[1]).length?n.push({name:e[1],lastMinute:!1,sets:[o]}):n.filter(n=>n.name===e[1])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(g),w=function(e){const n=[],t=new RegExp("^\\^.*\\?\\?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^(?:([a-zA-Z_]\\w*)!!?)?([a-zA-Z_]\\w*)\\?$").exec(r[2])){const o=e[1]||r[0];0===n.filter(n=>n.name===e[2]).length?n.push({name:e[2],sets:[o]}):n.filter(n=>n.name===e[2])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(g),[y,S,E]=c(o,$,w),M=d(E,l,e);w.forEach(e=>i(e,M)),M.forEach(e=>m(e,y,S));const R=function(e){const n=[],r="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z_]\\w*)",o=`^\\^(?:${r}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?=$`,s=`^\\^(?:${r}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\~$`,i=`^\\^(?:${r}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\%$`;for(const r of e)for(const c of r){const a=c[0],f=c[1];let l,u;if((l=new RegExp(o,"gm").exec(c[2]))?u="c":(l=new RegExp(s,"gm").exec(c[2]))?u="m":(l=new RegExp(i,"gm").exec(c[2]))&&(u="d"),u){const o=t(l[1]||a,a,e.length),s=t(l[2]||0,f,r.length),i=Number(l[3])||999;n.push([o,s,i,u,a,f])}}return n}(g),A=R.reverse(),z=[A.filter(e=>"c"===e[3]),A.filter(e=>"m"===e[3]),A.filter(e=>"d"===e[3])].flat();z.forEach(e=>(function(e,n){const t=[];for(const r of n[e[0]])if("d"!==r[3]&&"c"!==r[3]&&(t.push(r.map(e=>e)),"d"!==e[3]&&"m"!==e[3]||(r[3]="d"),0==--e[2]))break;t.forEach(e=>e.splice(3,1,"c")),"c"!==e[3]&&"m"!==e[3]||n[e[4]].splice(e[5],0,...t)})(e,y));const _=y.map(e=>e.filter(e=>"d"!==e[3])),b=n(_,[])[0].map((e,n)=>({name:e.name,elements:e.elements,lastMinute:o[n].lastMinute})),v=w.filter(e=>e.lastMinute),[k,N,Z]=c(b,$,v),P=d(Z,u,e);v.forEach(e=>i(e,P)),P.filter(e=>e.lastMinute).forEach(e=>m(e,k,N)),h.renderSets(k.map((e,n)=>({rendering:e,order:n})),f(e,f(e,p)))}}()}();
