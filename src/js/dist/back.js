!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function t(t){let n={};const s=`${e(t.openDelim)}`+"(.*?)"+`${e(t.closeDelim)}`,r=function(e=t.query){if(n[e])return n[e];{const t=document.querySelector(e),r=t?t.innerHTML:"",o=[],i=RegExp(s,"gm");let l=i.exec(r);for(;l;)o.push(l[1]),l=i.exec(r);return n[e]=o}},o=function(e=t.query){const n=[];for(const[s,o]of r(e).entries()){const e=o.split(t.fieldSeparator).map((e,t)=>[s,t,e]);n.push(e)}return n},i=function(e,n,s,l,c,a=t.query){const f=function(e,t){const n=e.find(e=>"default"===e.name).stylings;e.forEach(e=>{e.stylings.randomIndices=t[e.name]||[],e.stylings.nextIndex=0});return{defaultStyle:n,propAccessor:function(t,s=n){const r=t?e.find(e=>e.name===t).stylings:s,o=function(e){return void 0!==r[e]?r[e]:s[e]};let i;return{getProp:o,getIndex:function(){let e;return void 0===i?o("collectiveIndexing")&&o("randomStartIndex")?0===o("randomIndices").length?(e=Math.floor(Math.random()*o("colors").length),o("randomIndices").push(e)):e=0===o("nextIndex")?o("randomIndices")[0]:o("nextIndex")%o("colors").length:o("collectiveIndexing")?e=o("nextIndex")%o("colors").length:o("randomStartIndex")?(e=Math.floor(Math.random()*o("colors").length),o("randomIndices").push(e)):e=0:e=++i%o("colors").length,i=e,r.nextIndex=i+1,e}}},exportIndices:function(){const t={};return e.forEach(e=>{t[e.name]=e.stylings.randomIndices}),t}}}(n,l),d=Array(e.length);for(const[t,n]of e.entries()){const e=[],r=s[t],o=f.propAccessor(r);"sort"===o.getProp("display")?n.rendering.sort():"orig"===o.getProp("display")&&(n.rendering=c.find(e=>e.name===t).elements);for(const[t,s]of n.rendering.entries())if("d"!==s[3]){const t=o.getIndex(),n=o.getProp("colors")?` color: ${o.getProp("colors")[t]};`:"",r=`class="set-randomizer--element set-randomizer--element-index-${s[0]}-${s[1]}"`,i=`style="padding: 0px ${o.getProp("fieldPadding")}px;${n}"`;e.push(`<span ${r} ${i}>${s[2]}</span>`)}"none"===o.getProp("display")?d[n.order]="":0===e.length||"empty"===o.getProp("display")?d[n.order]=`${o.getProp("openDelim")}`+`${o.getProp("emptySet")}`+`${o.getProp("closeDelim")}`:d[n.order]=`${o.getProp("openDelim")}`+`${e.join(o.getProp("fieldSeparator"))}`+`${o.getProp("closeDelim")}`}const u=document.querySelector(a);let m=u?u.innerHTML:"";for(const[e,n]of r(a).entries()){const s=d[e];m=m.replace(`${t.openDelim}${n}${t.closeDelim}`,`${s}`)}if(document.querySelector(a).innerHTML=m,"div#clozed"===a){const t=o("div#original").flat();if(t.length>0){const n=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],t.find(t=>t[0]===e[0]&&t[1]===e[1])[2],e[3]]),order:e.order}));i(n,renderDirectives,l,"div#original")}}return f.exportIndices()};return{getOriginalStructure:o,renderSets:i}}const n="[a-zA-Z_]\\w*";function s(e,t,n,s,r,o,i,l){let c;if(n)c=[Number(n)];else if(s){const t=Number(s.slice(1));c=[e.length+t-1]}else if(o){const t=r+Number(o);c=e[t]?[t]:[]}else if(i){const n=t.find(e=>e.name===i),s=n?n.sets:[];if(n&&l){const t=Number(l)>=0?Number(l):e.length+Number(l)-1;c=s[t]>=0?[s[t]]:[]}else c=s}else c=[r];return c}function r(e,t,n,s){const r=Math.random()*(t-e)+e;return s?r.toFixed(n||2):(Math.round(r)*(n||1)).toString()}function o(e,t){const s=[],o=[],i=new RegExp(`^\\^(?:gen|g)\\((${n})\\s*,\\s\\[(.*)\\]\\)$`),l=[];for(const t of e.flat()){let e;(e=t[2].match(i))&&l.push({name:e[1],elements:e[2].substr(1,e[2].length-2).split(new RegExp("['\"],[\"']"))})}const c=new RegExp("^\\^(n|name)!!\\(\\)$"),a=new RegExp("^\\^(?:pick|p)\\((?:(\\d+(?:\\.\\d*)?):(\\d+(?:\\.\\d*)?)(?::(\\d+))?|"+`(${n})(?::(n(?:-\\d+)?|-\\d|\\d+))?)`+`(?:\\s*,\\s*(${n}))?\\)`),f=new RegExp("^[^\\^]"),d=[];for(const[n,i]of e.entries()){const e=[];let u=!1;for(const n of i){let s;if(c.test(n[2]))u=!0;else if(s=n[2].match(a)){const i=s[6],c=s[1],a=s[2],f=s[3],u=s[4],m=Number(s[5]);i&&!d.find(e=>e.name===i)&&d.push({name:i,values:[]});const h=n[0],p=n[1];let g,y;if(y=t.find(e=>e[0]===h&&e[1]===p))g=y[2];else if(c&&a){const e=c.includes(".")||a.includes(".");if(g=r(Number(c),Number(a),Number(f),e),i){let t=0;const n=1e3;for(;d.find(e=>e.name===i).values.includes(g)&&t<n;)g=r(Number(c),Number(a),Number(f),e),t++;t==n&&(g=null)}}else{const e=l.find(e=>e.name===u);if(e&&(g="number"!=typeof m||Number.isNaN(m)?e.elements[Math.floor(Math.random()*e.elements.length)]:m>=0?e.elements[e.elements.length<=m?null:m]:e.elements[e.elements.length+m<0?null:e.elements.length+m],i)){let t=0;const n=1e3;for(;d.find(e=>e.name===i).values.includes(g)&&t<n;){const n=Math.floor(Math.random()*e.elements.length);g=e.elements[n],t++}t==n&&(g=null)}}if(g){const t=[h,p,g];i&&d.find(e=>e.name===i).values.push(g),o.push(t),e.push(t)}}else(f.test(n[2])||0===n[2].length)&&e.push(n)}s.push({name:n,elements:e,lastMinute:u})}return[s,o]}function i(e){const t=new RegExp("^\\d+$"),n=new RegExp("^n(-\\d+)?$"),s=new RegExp("^((?:\\+|-)\\d+)$");return{processSetIndex:function(r,o,i){let l;if(l=r.toString().match(s)){const e=o+Number(l[1]);return e<0?null:i<e?null:[e]}if(l=r.toString().match(n)){const e=i-(Number(l[1])||0)-1;return e<0?null:[e]}if(l=r.toString().match(t)){const e=Number(r);return i<e?null:[e]}{const t=e.find(e=>e.name===r);return t?t.sets:[]}},processPositionIndex:function(e){let r;return e?(r=e.toString().match(s))?Number(r[1]):(r=e.toString().match(n))?Number(r[1]):(r=e.toString().match(t))?Number(e):void 0:null}}}function l(e){for(var t,n,s=e.length;0!==s;)n=Math.floor(Math.random()*s),t=e[s-=1],e[s]=e[n],e[n]=t;return e}function c(e){return e.map(e=>({name:e.name,length:e.elements.length,order:l([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function a(e,t){return e.map(e=>{const n=e.sets.map(e=>t.filter(t=>t.name===e)).map(e=>e[0].elements.length),s=n.reduce((e,t)=>e+t,0);return{name:e.name,length:s,sets:e.sets,setLengths:n,order:l([...new Array(s).keys()]),lastMinute:e.lastMinute}})}function f(e,t){const n=function(e,t){return e.sets.map(e=>({name:e,length:t.find(t=>t.name===e).length})).reduce((e,t)=>e.length<t.length?t:e).name}(e,t),s=t.find(e=>e.name===n).order;for(const n of e.sets){const r=t.find(e=>e.name===n).order,o=s.filter(e=>e<r.length);t.forEach(t=>{t.name===n&&(t.order=o,e.lastMinute&&(t.lastMinute=!0))})}return t}function d(e,t,n){const s=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),r=JSON.parse(JSON.stringify(s)),o=[c(e),a(t,e)].flat();return n.forEach(e=>f(e,o)),[s,r,o]}function u(e,t){if(!t||e.length!==t.length)return!1;for(let n=0,s=e.length;n<s;n++)if(e[n]instanceof Array&&t[n]instanceof Array){if(!u(e[n],t[n]))return!1}else if(e[n]!=t[n])return!1;return!0}function m(e,t){t-=e.length*Math.floor(t/e.length),e.push.apply(e,e.splice(0,t))}function h(e,t){const n=[];for(const t of e)n.push(t);for(const e of t)n.includes(e)||n.push(e);return n}function p(e,t){const n=[];for(const s of t){const t=e[s];t&&n.push(t)}if(t.length<e.length)for(const s of Array.from(new Array(e.length-t.length),(e,n)=>n+t.length))n.push(e[s]);return n}function g(e,t){switch(typeof e.name){case"number":t[e.name]=p(t[e.name],e.order);break;case"string":(function(e,t){const n=[];let s=0;for(const r of t)n.push(e.slice(s,s+r)),s+=r;return n})(p(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((n,s)=>{t[e.sets[s]]=n})}}function y(e,t,n){const s=[];for(const r of e){let e;"string"==typeof r.name?(e=t.find(e=>r.name===e.name))?s.push({name:r.name,length:r.length,sets:r.sets,setLengths:r.setLengths,order:h(e.order,r.order),lastMinute:r.lastMinute}):s.push(r):(e=n.find(e=>r.name===e.to))?s.push(t.find(t=>t.name===e.from)):s.push(r)}return s}window.Persistence&&Persistence.isAvailable()&&function(){const e=Persistence.getItem("AnkiSetRandomizerOriginalStructure"),r=Persistence.getItem("AnkiSetRandomizerInputSyntax"),l=Persistence.getItem("AnkiSetRandomizerDefaultStyle"),c=Persistence.getItem("AnkiSetRandomizerGeneratorValues"),a=Persistence.getItem("AnkiSetRandomizerNewReorders"),h=Persistence.getItem("AnkiSetRandomizerLastMinuteReorders"),p=Persistence.getItem("AnkiSetRandomizerRandomIndices");if(!(e&&r&&l&&c&&a&&h&&p))return;const x=t(r),$=x.getOriginalStructure();if($){const t=function(e,t){const n=[];for(const s of e)for(const e of t)!u(s.map(e=>e[2]),e.map(e=>e[2]))||n.find(t=>t.from===e[0][0])||n.find(e=>e.to===s[0][0])||n.push({from:e[0][0],to:s[0][0]});return n}($,e),[r,S]=o($,function(e,t){const n=[];for(const s of t){const t=e.find(e=>e.from===s[0]);t&&n.push([t.to,s[1],s[2]])}return n}(t,c)),I=function(e){const t=new RegExp("\\^(?:name|n)(!)?\\("+`(${n})`+"(?:\\s*,\\s*(?:(\\d+)|(n-\\d+)|((?:\\+|-)\\d+)|"+`(${n})(?::(n-\\d+|-\\d|\\d+))?`+"))?\\)$"),r=[];return e.flat().map(e=>[...e,e[2].match(t)]).filter(e=>e[3]).reduce((e,t)=>(t[3][3]||t[3][4]||t[3][5]||t[3][6]||t[3][7]?e.push(t):e.unshift(t),e),[]).forEach(t=>{const[n,o,i,l,c,a,f,d]=t[3],u=s(e,r,l,c,t[0],a,f,d);let m=r.find(e=>e.name===i);if(!m){const e=r.push({name:i,lastMinute:!1,sets:[]});m=r[e-1]}m.sets.push(...u),m.sets.sort(),o&&(m.lastMinute=!0)}),r}($),M=function(e,t){const r=[],o=new RegExp("\\^(?:order|ord|o)(!)?\\("+`(${n})`+"(?:\\s*,\\s*(?:(\\d+)|(n-\\d+)|((?:\\+|-)\\d+)|"+`(${n})(?::(n-\\d+|-\\d|\\d+))?`+"))?\\)$");return e.flat().map(e=>[...e,e[2].match(o)]).filter(e=>e[3]).forEach(n=>{const[o,i,l,c,a,f,d,u]=n[3],m=s(e,t,c,a,n[0],f,d,u);let h=r.find(e=>e.name===l);if(!h){const e=r.push({name:l,lastMinute:!1,sets:[],dictator:!1});h=r[e-1]}h.sets.push(...m),h.sets.sort(),i&&(h.lastMinute=!0)}),r}($,I),b=function(e,t,s){const r=[],o=`(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|${n})`,l=new RegExp("^\\^(?:(c|copy)|(m|move)|(d|del|delete))\\((?:"+`${o}(?::(n(?:-\\d+)?|-\\d|\\d+))?`+"(?:\\s*,\\s*(\\d+)(?:"+`\\s*,\\s*${o}(?::(n(?:-\\d+)?|-\\d|\\d+))?`+")?)?)?\\)$");for(const n of e.flat()){let o;if(o=n[2].match(l)){const l=o[1]?"c":o[2]?"m":o[3]?"d":"",c=i(s),a=c.processSetIndex(o[7]||n[0],n[0],e.length),f=o[8]?c.processSetIndex(o[8]):o[7]?0:t.find(e=>e.name===a[0]).elements.reduce((e,t)=>t[1]<n[1]?e+1:e,0),[d,u]=t.filter(e=>a.includes(e.name)).reduce((e,t,n,s)=>e[1]-(t.elements.length+1)<0?[e[0]||t.name,e[1]]:[null,e[1]-(t.elements.length+1)],[null,f]),m=c.processSetIndex(o[4]||a,n[0],e.length),h=c.processPositionIndex(o[5])||0,p=/\d/.test(o[6])?Number(o[6]):999;null!==m&&null!==d&&p>0&&r.push([m,h,p,l,d,u])}}return r}($,r,I),[E,P]=function(e,t,r){const o=[{name:"default",stylings:t},{name:"none",stylings:{display:"none"}}],i=new RegExp("^\\^(?:style|s)\\("+`(${n})`+"\\s*,\\s(.*)\\)$"),l=new RegExp(":(.*)$");e.flat().map(e=>[...e,e[2].match(i)]).filter(e=>e[3]).forEach(e=>{const[t,n,s]=e[3];let r=o.find(e=>e.name===n);if(!r){const e=o.push({name:n,stylings:{}});r=o[e-1]}s.split(",").map(e=>e.trim()).forEach(e=>{if(e.startsWith("od:")||e.startsWith("openDelim:"))r.stylings.openDelim=e.match(l)[1];else if(e.startsWith("cd:")||e.startsWith("closeDelim:"))r.stylings.closeDelim=e.match(l)[1];else if(e.startsWith("fs:")||e.startsWith("fieldSeparator:"))r.stylings.fieldSeparator=e.match(l)[1];else if(e.startsWith("fp:")||e.startsWith("fieldPadding:")){const t=Number(e.match(l)[1]);t>=0&&(r.stylings.fieldPadding=t)}else if(e.startsWith("clrs:")||e.startsWith("colors:")){const t=e.match(l)[1].split(":");r.stylings.colors=t}else if(e.startsWith("ci:")||e.startsWith("collectiveIndexing:")){const t=e.match(l)[1],n="true"===t||"false"!==t&&null;"boolean"==typeof n&&(r.stylings.collectiveIndexing=n)}else if(e.startsWith("rsi:")||e.startsWith("randomStartIndex:")){const t=e.match(l)[1],n="true"===t||"false"!==t&&null;"boolean"==typeof n&&(r.stylings.randomStartIndex=n)}else(e.startsWith("dp:")||e.startsWith("display:"))&&(r.stylings.display=e.match(l)[1])})});const c=[],a=new RegExp("^\\^(?:apply|app|a)\\("+`(${n})`+"(?:\\s*,\\s(?:(\\d+)|(n-\\d+)|((?:\\+|-)\\d+)|"+`(${n})(?::(n-\\d+|-\\d|\\d+))?`+"))?\\)$");return e.flat().map(e=>[...e,e[2].match(a)]).filter(e=>e[3]).forEach(t=>{const[n,i,l,a,f,d,u]=t[3];o.find(e=>e.name===i)&&s(e,r,l,a,t[0],f,d,u).forEach(e=>c[e]=i)}),[o,c]}($,l,I),[N,R,w]=d(r,I,M),v=y(w,a,t);M.forEach(e=>f(e,v)),v.forEach(e=>g(e,N)),b.sort((e,t)=>e[3]===t[3]?0:"c"===e[3]?-1:"m"===e[3]&&"d"===t[3]?-1:"m"===e[3]&&"c"===t[3]?1:"d"===e[3]?1:void 0).forEach(e=>(function(e,t){const n=e[0],s=e[1],r=e[3],o=e[4],i=e[5];let l;switch(typeof n){case"number":l=t[n];break;case"object":l=n.flatMap(e=>t[e])}if(l.length<=s||s<-l.length)return;m(l,s);const c=[];let a=e[2];for(const e of l){const t=e[3];if("d"!==t&&"c"!==t&&(c.push(e.slice(0)),"d"!==r&&"m"!==r||(e[3]="d"),0==--a))break}if(c.forEach(e=>e.splice(3,1,"c")),("c"===r||"m"===r)&&c.length>0){let e=i,n=0;for(;e>0;)n+=t[o].slice(n).findIndex(e=>"n"===e[3]||"d"===e[3]),n++,e--;t[o].splice(n,0,...c)}m(l,-s)})(e,N));const A=N.map(e=>e.filter(e=>"d"!==e[3])),W=o(A,[])[0].map((e,t)=>({name:e.name,elements:e.elements,lastMinute:r[t].lastMinute})),D=M.filter(e=>e.lastMinute),[k,z,L]=d(W,I,D),q=y(L,h,t);D.forEach(e=>f(e,q)),q.filter(e=>e.lastMinute).forEach(e=>g(e,k)),x.renderSets(function(e,t){const n=Array(t.length);for(const[s,r]of t.map((e,t)=>({rendering:e,order:t})).entries()){const t=e.find(e=>s===e.to);t?n[t.from]=r:n.push(r)}return n.filter(e=>void 0!==e)}(t,k),E,P,p,r)}}()}();
