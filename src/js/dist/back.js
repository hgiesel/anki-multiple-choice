!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function n(e,n){const t=[],r=[],o=new RegExp("^\\^!!?$"),s=new RegExp("^[^\\^]");for(const[a,f]of e.entries()){const e=[];let l=!1;for(const t of f){let a;if(o.test(t[2]))l=!0;else if(a=new RegExp("^\\^(\\d+(?:\\.\\d*)?),(\\d+(?:\\.\\d*)?)(?:,(\\d+))?#$","gm").exec(t[2])){const o=t[0],s=t[1];let f;const l=n.find(e=>e[0]===o&&e[1]===s);if(l)f=l;else{const e=a[1],n=a[2],t=a[3],r=e.includes(".")||n.includes("."),l=(i=Number(e),c=Number(n),Math.random()*(c-i)+i),u=r?l.toFixed(t||2):(Math.round(l)*(t||1)).toString();f=[o,s,u]}r.push(f),e.push(f)}else s.test(t[2])&&e.push(t)}t.push({name:a,elements:e,lastMinute:l})}var i,c;return[t,r]}function t(e,n,t){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?n+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?n-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?t-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function r(e){for(var n,t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),n=e[r-=1],e[r]=e[t],e[t]=n;return e}function o(e){return e.map(e=>({name:e.name,length:e.elements.length,order:r([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function s(e,n){return e.map(e=>{const t=e.sets.map(e=>n.filter(n=>n.name===e)).map(e=>e[0].elements.length),o=t.reduce((e,n)=>e+n,0);return{name:e.name,length:o,sets:e.sets,setLengths:t,order:r([...new Array(o).keys()]),lastMinute:e.lastMinute}})}function i(e,n,t){const r=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),i=JSON.parse(JSON.stringify(r)),c=[o(e),s(n,e)].flat();return t.forEach(e=>(function(e,n){const t=function(e,n){return e.sets.map(e=>({name:e,length:n.filter(n=>n.name===e)[0].length})).reduce((e,n)=>e.length<n.length?n:e).name}(e,n),r=n.filter(e=>e.name===t)[0].order;for(const t of e.sets){const e=n.filter(e=>e.name===t)[0].order,o=r.filter(n=>n<e.length);n.forEach(e=>{e.name===t&&(e.order=o)})}return n})(e,c)),[r,i,c]}function c(e,n){if(!n||e.length!==n.length)return!1;for(let t=0,r=e.length;t<r;t++)if(e[t]instanceof Array&&n[t]instanceof Array){if(!c(e[t],n[t]))return!1}else if(e[t]!=n[t])return!1;return!0}function a(e,n){const t=[];let r;for(const[o,s]of n.entries())(r=e.find(e=>e.from===o))&&(t[r.to]=s);return t}function f(e,n){const t=[];for(const n of e)t.push(n);for(const e of n)t.includes(e)||t.push(e);return t}function l(e,n){const t=[];for(const r of n){const n=e[r];n&&t.push(n)}if(n.length<e.length)for(const r of Array.from(new Array(e.length-n.length),(e,t)=>t+n.length))t.push(e[r]);return t}function u(e,n,t){switch(typeof e.name){case"number":const r=t[e.name];n[e.name]=l(r,e.order);break;case"string":(function(e,n){const t=[];let r=0;for(const o of n)t.push(e.slice(r,r+o)),r+=o;return t})(l(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}}function m(e,n,t){const r=[];for(const o of e){let e;"string"==typeof o.name?(e=n.find(e=>o.name===e.name))?r.push({name:o.name,length:o.length,sets:o.sets,setLengths:o.setLengths,order:f(e.order,o.order),lastMinute:o.lastMinute}):r.push(o):(e=t.find(e=>o.name===e.to))?r.push(n.find(n=>n.name===e.from)):r.push(o)}return r}window.Persistence&&Persistence.isAvailable()&&function(){const r=Persistence.getItem("AnkiSetRandomizerOriginalStructure"),o=Persistence.getItem("AnkiSetRandomizerOptions"),s=Persistence.getItem("AnkiSetRandomizerGeneratorValues"),f=Persistence.getItem("AnkiSetRandomizerNewReorders"),l=Persistence.getItem("AnkiSetRandomizerLastMinuteReorders"),d=Persistence.getItem("AnkiSetRandomizerRandomIndices");if(!(r&&o&&s&&f&&l&&d))return;const p=function(n){let t={};const r=`${e(n.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(n.inputSyntax.closeDelim)}`,o=function(e=n.query){if(t[e])return t[e];{const n=document.querySelector(e),o=n?n.innerHTML:"",s=[],i=RegExp(r,"gm");let c=i.exec(o);for(;c;)s.push(c[1]),c=i.exec(o);return t[e]=s}},s=function(e=n.query){const t=[];for(const[r,s]of o(e).entries()){const e=s.split(n.inputSyntax.fieldSeparator).map((e,n)=>[r,n,e]);t.push(e)}return t},i=function(e,t,r=n.query){let c=0+(n.colors_random_start_index?Math.floor((t[0]||Math.random())*n.colors.length):0);const a=Array(e.length);for(const[r,o]of e.entries()){const e=[],s=n.colors_random_start_index?Math.floor((t[r]||Math.random())*n.colors.length):0;for(const[t,r]of o.rendering.entries())if("d"!==r[3]){const o=(n.colors_collective_indexing?c++:s+t)%n.colors.length,i=`class="set-randomizer--element set-randomizer--element-index-${r[0]}-${r[1]}"`,a=n.colors[o]?` color: ${n.colors[o]};`:"",f=`style="padding: 0px ${n.fieldPadding}px;${a}"`;e.push(`<span ${i} ${f}>${r[2]}</span>`)}a[o.order]=e.join(n.outputSyntax.fieldSeparator)}const f=document.querySelector(r);let l=f?f.innerHTML:"";for(const[e,t]of o(r).entries())l=l.replace(`${n.inputSyntax.openDelim}${t}${n.inputSyntax.closeDelim}`,`${n.outputSyntax.openDelim}${a[e]}${n.outputSyntax.closeDelim}`);if(document.querySelector(r).innerHTML=l,"div#clozed"===r){const n=s("div#original").flat();if(n.length>0){const r=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],n.find(n=>n[0]===e[0]&&n[1]===e[1])[2],e[3]]),order:e.order}));i(r,t,"div#original")}}};return{getOriginalStructure:s,renderSets:i}}(o),g=p.getOriginalStructure();if(g){const e=function(e,n){const t=[];for(const r of e)for(const e of n)!c(r.map(e=>e[2]),e.map(e=>e[2]))||t.find(n=>n.from===e[0][0])||t.find(e=>e.to===r[0][0])||t.push({from:e[0][0],to:r[0][0]});return t}(g,r),[o,h]=n(g,function(e,n){const t=[];for(const r of n){const n=e.find(e=>e.from===r[0]);n&&t.push([n.to,r[1],r[2]])}return t}(e,s)),x=function(e){const n=[],t=new RegExp("^\\^.*!!(?:[a-zA-Z_][a-zA-Z0-9_]*\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z_][a-zA-Z0-9_]*)!!?(?:[a-zA-Z_][a-zA-Z0-9_]*\\?\\??)?$").exec(r[2])){const o=r[0];0===n.filter(n=>n.name===e[1]).length?n.push({name:e[1],lastMinute:!1,sets:[o]}):n.filter(n=>n.name===e[1])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(g),$=function(e){const n=[],t=new RegExp("^\\^.*\\?\\?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^(?:([a-zA-Z_][a-zA-Z0-9_]*)!!?)?([a-zA-Z_][a-zA-Z0-9_]*)\\?$").exec(r[2])){const o=e[1]||r[0];0===n.filter(n=>n.name===e[2]).length?n.push({name:e[2],sets:[o]}):n.filter(n=>n.name===e[2])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(g),[y,S,A]=i(o,x,$),M=m(A,f,e);M.forEach(e=>u(e,y,S));const R=function(e){const n=[],r="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z_][a-zA-Z0-9_]*)",o=`^\\^${r}(?::(\\d+|n(?:-\\d+)?))?,(?:(\\d+))?=$`,s=`^\\^${r}(?::(\\d+|n(?:-\\d+)?))?,(?:(\\d+))?\\~$`;for(const r of e)for(const i of r){const c=i[0],a=i[1];let f,l;if((f=new RegExp(o,"gm").exec(i[2]))?l="c":(f=new RegExp(s,"gm").exec(i[2]))?l="m":(f=new RegExp("^\\^(?:(\\d+))?\\%$","gm").exec(i[2]))&&(l="d"),"c"===l||"m"===l){const o=t(f[1],c,e.length),s=t(f[2]||0,a,r.length),i=Number(f[3])||999;n.push([o,s,i,l,c,a])}else if("d"===l){const e=c,t=a,r=Number(f[1])||999;n.push([e,t,r,l,c,a])}}return n}(g),E=R.reverse(),w=[E.filter(e=>"m"===e[3]),E.filter(e=>"c"===e[3]),E.filter(e=>"d"===e[3])].flat();w.forEach(e=>(function(e,n){const t=[];for(const r of n[e[0]])if("d"!==r[3]&&(t.push(r.map(e=>e)),"dm".includes(e[3])&&(r[3]="d"),0==--e[2]))break;t.forEach(e=>e.splice(3,1,"c")),"cm".includes(e[3])&&n[e[4]].splice(e[5],0,...t)})(e,y));const z=y.map(e=>e.filter(e=>"d"!==e[3])),_=n(z,[])[0].map((e,n)=>({name:e.name,elements:e.elements,lastMinute:o[n].lastMinute})),[b,Z,N]=i(_,x,$.filter(e=>e.lastMinute)),k=m(N,l,e);k.filter(e=>e.lastMinute).forEach(e=>u(e,b,Z)),p.renderSets(b.map((e,n)=>({rendering:e,order:n})),a(e,a(e,d)))}}()}();
