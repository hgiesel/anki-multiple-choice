!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function t(t){let n={};const s=`${e(t.openDelim)}`+"((?:.|\\n|\\r)*?)"+`${e(t.closeDelim)}`,r=function(e=t.query){if(n[e])return n[e];{const t=document.querySelector(e),r=t?t.innerHTML:"",o=[],l=RegExp(s,"gm");let i=l.exec(r);for(;i;)o.push(i[1]),i=l.exec(r);return n[e]=o}},o=function(e=t.query){const n=[];for(const[s,o]of r(e).entries()){const e=o.split(t.fieldSeparator).map((e,t)=>[s,t,e]);n.push(e)}return n},l=function(e,n,s,i,c,a=t.query){const d=function(e,t){const n=e.find(e=>"default"===e.name).stylings;e.forEach(e=>{e.stylings.randomIndices=t[e.name]||[],e.stylings.nextIndex=0});return{defaultStyle:n,propAccessor:function(t,s=n){const r=t?e.find(e=>e.name===t).stylings:s,o=function(e){return void 0!==r[e]?r[e]:s[e]};let l;return{getProp:o,getIndex:function(){let e;return void 0===l?o("collectiveIndexing")&&o("randomStartIndex")?0===o("randomIndices").length?(e=Math.floor(Math.random()*o("colors").length),o("randomIndices").push(e)):e=0===o("nextIndex")?o("randomIndices")[0]:o("nextIndex")%o("colors").length:o("collectiveIndexing")?e=o("nextIndex")%o("colors").length:o("randomStartIndex")?(e=Math.floor(Math.random()*o("colors").length),o("randomIndices").push(e)):e=0:e=++l%o("colors").length,l=e,r.nextIndex=l+1,e}}},exportIndices:function(){const t={};return e.forEach(e=>{t[e.name]=e.stylings.randomIndices}),t}}}(n,i),f=Array(e.length);for(const[t,n]of e.entries()){const e=[],r=s[t],o=d.propAccessor(r);"sort"===o.getProp("display")?n.rendering.sort():"orig"===o.getProp("display")&&(n.rendering=c.find(e=>e.name===t).elements);for(const[t,s]of n.rendering.entries())if("d"!==s[3]){const t=o.getIndex(),n=o.getProp("colors")?` color: ${o.getProp("colors")[t]};`:"",r=`class="set-randomizer--element set-randomizer--element-index-${s[0]}-${s[1]}"`,l="block"===o.getProp("display")?" display: block;":"",i=`style="padding: 0px ${o.getProp("fieldPadding")}px;${n}${l}"`,c="block"===o.getProp("display")?`<record ${r} ${i}><div>${u=s[2],u.replace(RegExp("</div><div>","g"),"<br>").replace(RegExp("<div>","g"),"<br>")}</div></record>`:`<record ${r} ${i}>${s[2]}</record>`;e.push(c)}"none"===o.getProp("display")?f[n.order]="":0===e.length||"empty"===o.getProp("display")?f[n.order]=`${o.getProp("openDelim")}`+`${o.getProp("emptySet")}`+`${o.getProp("closeDelim")}`:f[n.order]=`${o.getProp("openDelim")}`+`${e.join(o.getProp("fieldSeparator"))}`+`${o.getProp("closeDelim")}`}var u;const m=document.querySelector(a);let p=m?m.innerHTML:"";for(const[e,n]of r(a).entries()){const s=f[e];p=p.replace(`${t.openDelim}${n}${t.closeDelim}`,`${s}`)}if(document.querySelector(a).innerHTML=p,"div#clozed"===a){const t=o("div#original").flat();if(t.length>0){const n=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],t.find(t=>t[0]===e[0]&&t[1]===e[1])[2],e[3]]),order:e.order}));l(n,renderDirectives,i,"div#original")}}return d.exportIndices()};return{getOriginalStructure:o,renderSets:l}}const n="[a-zA-Z_]\\w*";function s(e,t,n,s,r,o,l,i){let c;if(n)c=[Number(n)];else if(s){const t=Number(s.slice(1));c=[e.length+t-1]}else if(o){const t=r+Number(o);c=e[t]?[t]:[]}else if(l){const n=t.find(e=>e.name===l),s=n?n.sets:[];if(n&&i){const t=Number(i)>=0?Number(i):e.length+Number(i)-1;c=s[t]>=0?[s[t]]:[]}else c=s}else c=[r];return c}function r(e,t,n,s){const r=Math.random()*(t-e)+e;return s?r.toFixed(n||2):(Math.round(r)*(n||1)).toString()}function o(e,t){const s=[],o=[],l=new RegExp("^\\^(?:generate|gen|g)\\("+`(${n})\\s*,\\s*`+"\\[((?:.|\\n|\\r)*)\\]\\)","m"),i=[],c=new RegExp("\\\\'","g"),a=new RegExp('\\\\"',"g"),d=new RegExp("\\\\n","g"),f=new RegExp("\\\\.","g");for(const t of e.flat()){let e;if(e=t[2].match(l)){const n=[],s=new RegExp("(?:'((?:.|\\n|\\r)*?[^\\\\])'|\"((?:.|\\n|\\r)*?[^\\\\])\")","g");let r=s.exec(t[2]);for(;r;)r[1]?n.push(r[1].replace(c,"'").replace(d,"<br/>").replace(f,e=>e.slice(1))):r[2]&&n.push(r[2].replace(a,'"').replace(d,"<br/>").replace(f,e=>e.slice(1))),r=s.exec(t[2]);i.push({name:e[1],elements:n})}}const u=new RegExp("^\\^(n|name)!\\(\\)$"),m=new RegExp("^\\^(?:pick|p)\\((?:(\\d+(?:\\.\\d*)?):(\\d+(?:\\.\\d*)?)(?::(\\d+))?|"+`(${n})(?::(n(?:-\\d+)?|-\\d|\\d+))?)`+`(?:\\s*,\\s*(${n}))?\\)`),p=new RegExp("^[^\\^]"),g=[];for(const[n,l]of e.entries()){const e=[];let c=!1;for(const n of l){let s;if(u.test(n[2]))c=!0;else if(s=n[2].match(m)){const l=s[6],c=s[1],a=s[2],d=s[3],f=s[4],u=Number(s[5]);l&&!g.find(e=>e.name===l)&&g.push({name:l,values:[]});const m=n[0],p=n[1];let h,y;if(y=t.find(e=>e[0]===m&&e[1]===p))h=y[2];else if(c&&a){const e=c.includes(".")||a.includes(".");if(h=r(Number(c),Number(a),Number(d),e),l){let t=0;const n=1e3;for(;g.find(e=>e.name===l).values.includes(h)&&t<n;)h=r(Number(c),Number(a),Number(d),e),t++;t==n&&(h=null)}}else{const e=i.find(e=>e.name===f);if(e&&(h="number"!=typeof u||Number.isNaN(u)?e.elements[Math.floor(Math.random()*e.elements.length)]:u>=0?e.elements[e.elements.length<=u?null:u]:e.elements[e.elements.length+u<0?null:e.elements.length+u],l)){let t=0;const n=1e3;for(;g.find(e=>e.name===l).values.includes(h)&&t<n;){const n=Math.floor(Math.random()*e.elements.length);h=e.elements[n],t++}t==n&&(h=null)}}if(h){const t=[m,p,h];l&&g.find(e=>e.name===l).values.push(h),o.push(t),e.push(t)}}else(p.test(n[2])||0===n[2].length)&&e.push(n)}s.push({name:n,elements:e,lastMinute:c})}return[s,o]}function l(e,t,n,s,r,o,l){if(e){const t=Number(e);return o<=t?[[],!0]:[[t],!0]}if(t){const e=r+Number(t);return e<0?[[],!0]:o<e?[[],!0]:[[e],!0]}if(n){const e=o+(Number(n)-1);return e<0?[[],!0]:[[e],!0]}if(s){const e=l.find(e=>e.name===s);return e?[e.sets,!0]:[[],!0]}return[[r],!1]}const i=function(e,t,n,s,r,o){return void 0!==e?e:void 0!==t?t:n?0:r.find(e=>e.name===s).elements.reduce((e,t)=>t[1]<o?e+1:e,0)};function c(e){for(var t,n,s=e.length;0!==s;)n=Math.floor(Math.random()*s),t=e[s-=1],e[s]=e[n],e[n]=t;return e}function a(e){return e.map(e=>({name:e.name,length:e.elements.length,sets:[e.name],setLengths:[e.elements.length],order:c([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function d(e,t){return e.map(e=>{const n=e.sets.map(e=>t.filter(t=>t.name===e)).map(e=>e[0].elements.length),s=n.reduce((e,t)=>e+t,0);return{name:e.name,length:s,sets:e.sets,setLengths:n,order:c([...new Array(s).keys()]),lastMinute:e.lastMinute}})}function f(e,t){const n=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e);JSON.parse(JSON.stringify(n));return[n,[a(e),d(t,e)].flat()]}function u(e,t){t.forEach(t=>(function(e,t){const n=function(e,t){return e.sets.map(e=>({name:e,length:t.find(t=>t.name===e).length})).reduce((e,t)=>e.length<t.length?t:e).name}(e,t);e.dictator=n;const s=t.find(t=>t.name===e.dictator).order;for(const n of e.sets){const r=t.find(e=>e.name===n).order,o=s.filter(e=>e<r.length);t.forEach(t=>{t.name===n&&(t.order=o,e.lastMinute&&(t.lastMinute=!0))})}return t})(t,e))}function m(e,t){t-=e.length*Math.floor(t/e.length),e.push.apply(e,e.splice(0,t))}function p(e,t){const n=[];for(const s of t){const t=e[s];t&&n.push(t)}if(t.length<e.length)for(const s of Array.from(new Array(e.length-t.length),(e,n)=>n+t.length))n.push(e[s]);return n}function g(e,t){const n=[];let s=0;for(const r of t)n.push(e.slice(s,s+r)),s+=r;return n}function h(e,t){const n=e.slice(0).sort((e,t)=>e.sets.length>t.sets.length?-1:e.sets.length<t.sets.length?1:"string"==typeof e.name?-1:1),s=[];for(const e of n){if(!s.reduce((t,n)=>t||e.sets.every(e=>n.includes(e)),!1)){g(p(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((n,s)=>{t[e.sets[s]]=n}),s.push(e.sets)}}}function y(e,t){e.sort((e,t)=>e[0]===t[0]?0:"c"===e[0]?-1:"m"===e[0]&&"d"===t[0]?-1:"m"===e[0]&&"c"===t[0]?1:"d"===e[0]?1:void 0).forEach(e=>(function(e,t){const n=e[0],s=e[2],r=e[3],o=e[4],l=e[5];let i;switch(typeof s){case"number":i=t[s];break;case"object":i=s.flatMap(e=>t[e])}if(i.length<=r||r<-i.length)return;m(i,r);const c=[];let a=e[1];for(const e of i){const t=e[3];if("d"!==t&&"c"!==t&&(c.push(e.slice(0)),"d"!==n&&"m"!==n||(e[3]="d"),0==--a))break}if(c.forEach(e=>e.splice(3,1,"c")),("c"===n||"m"===n)&&c.length>0){let e=l,n=0;for(;e>0;)n+=t[o].slice(n).findIndex(e=>"n"===e[3]||"d"===e[3]),n++,e--;t[o].splice(n,0,...c)}m(i,-r)})(e,t))}window.Persistence&&Persistence.isAvailable()&&function(){const e={query:$$query,openDelim:$$input_syntax_open_delim,closeDelim:$$input_syntax_close_delim,fieldSeparator:$$input_syntax_field_separator},r={colors:$$colors,collectiveIndexing:$$colors_collective_indexing,randomStartIndex:$$colors_random_start_index,fieldPadding:$$field_padding,openDelim:$$output_syntax_open_delim,closeDelim:$$output_syntax_close_delim,fieldSeparator:$$output_syntax_field_separator,emptySet:$$output_syntax_empty_set},c=document.querySelector(e.query);if(!c||!c.innerHTML||c.innerHTML.includes("SET RANDOMIZER FRONT TEMPLATE")||c.innerHTML.includes("SET RANDOMIZER BACK TEMPLATE"))return;const a=t(e),d=a.getOriginalStructure();if(d){const[t,c]=o(d,[]),m=function(e){const t=new RegExp("\\^(?:name|n)(!)?\\("+`(${n})`+"(?:\\s*,\\s*(?:(\\d+)|(n-\\d+)|((?:\\+|-)\\d+)|"+`(${n})(?::(n-\\d+|-\\d|\\d+))?`+"))?\\)$"),r=[];return e.flat().map(e=>[...e,e[2].match(t)]).filter(e=>e[3]).reduce((e,t)=>(t[3][3]||t[3][4]||t[3][5]||t[3][6]||t[3][7]?e.push(t):e.unshift(t),e),[]).forEach(t=>{const[n,o,l,i,c,a,d,f]=t[3],u=s(e,r,i,c,t[0],a,d,f);let m=r.find(e=>e.name===l);if(!m){const e=r.push({name:l,lastMinute:!1,sets:[]});m=r[e-1]}m.sets.push(...u),m.sets.sort(),o&&(m.lastMinute=!0)}),r}(d),p=function(e,t){const r=[],o=new RegExp("\\^(?:order|ord|o)(!)?\\("+`(${n})`+"(?:\\s*,\\s*(?:(\\d+)|(n-\\d+)|((?:\\+|-)\\d+)|"+`(${n})(?::(n-\\d+|-\\d|\\d+))?`+"))?\\)$");return e.flat().map(e=>[...e,e[2].match(o)]).filter(e=>e[3]).forEach(n=>{const[o,l,i,c,a,d,f,u]=n[3],m=f&&!u?[f]:s(e,t,c,a,n[0],d,f,u);let p=r.find(e=>e.name===i);if(!p){const e=r.push({name:i,lastMinute:!1,sets:[],dictator:!1});p=r[e-1]}p.sets.push(...m),p.sets.sort(),l&&(p.lastMinute=!0)}),r}(d,m),g=function(e,t,n){const s=[],r="(?:(\\d+)|((?:\\+|-)\\d+)|n(-\\d+)|([a-zA-Z_]\\w*))",o=new RegExp("^\\^(?:(c|copy)|(m|move)|(d|del|delete))\\((?:(\\d+)(?:\\s*,\\s*"+`${r}(?::(?:\\+?(\\d+)|n?(-\\d+)))?`+"(?:\\s*,\\s*"+`${r}(?::(?:\\+?(\\d+)|n?(-\\d+)))?`+")?)?)?\\)$");for(const r of e.flat()){const c=r[2].match(o);if(c){const o=c[1]?"c":c[2]?"m":c[3]?"d":"",a=c[4]?Number(c[4]):999,[d,f]=l(c[11],c[12],c[13],c[14],r[0],e.length,n),u=i(c[15],c[16],f,d[0]?d[0]:r[0],t,r[1]),[m,p]=t.filter(e=>d.includes(e.name)).reduce((e,t,n,s)=>e[1]-(t.elements.length+1)<0?[e[0]||t.name,e[1]]:[null,e[1]-(t.elements.length+1)],[null,u]),[g,h]=l(c[5],c[6],c[7],c[8],r[0],e.length,n),y=i(c[9],c[10],!0,r[0],t,r[1]);null!==g&&null!==m&&a>0&&s.push([o,a,g,y,m,p])}}return console.log(s),s}(d,t,m),[$,x]=function(e,t,r){const o=[{name:"default",stylings:t},{name:"none",stylings:{display:"none"}},{name:"block",stylings:{display:"block",openDelim:"",closeDelim:"",fieldPadding:0}}],l=new RegExp("^\\^(?:style|s)\\("+`(${n})`+"\\s*,\\s(.*)\\)$"),i=new RegExp(":(.*)$");e.flat().map(e=>[...e,e[2].match(l)]).filter(e=>e[3]).forEach(e=>{const[t,n,s]=e[3];let r=o.find(e=>e.name===n);if(!r){const e=o.push({name:n,stylings:{}});r=o[e-1]}s.split(",").map(e=>e.trim()).forEach(e=>{if(e.startsWith("od:")||e.startsWith("openDelim:"))r.stylings.openDelim=e.match(i)[1];else if(e.startsWith("cd:")||e.startsWith("closeDelim:"))r.stylings.closeDelim=e.match(i)[1];else if(e.startsWith("fs:")||e.startsWith("fieldSeparator:"))r.stylings.fieldSeparator=e.match(i)[1];else if(e.startsWith("fp:")||e.startsWith("fieldPadding:")){const t=Number(e.match(i)[1]);t>=0&&(r.stylings.fieldPadding=t)}else if(e.startsWith("clrs:")||e.startsWith("colors:")){const t=e.match(i)[1].split(":");r.stylings.colors=t}else if(e.startsWith("ci:")||e.startsWith("collectiveIndexing:")){const t=e.match(i)[1],n="true"===t||"false"!==t&&null;"boolean"==typeof n&&(r.stylings.collectiveIndexing=n)}else if(e.startsWith("rsi:")||e.startsWith("randomStartIndex:")){const t=e.match(i)[1],n="true"===t||"false"!==t&&null;"boolean"==typeof n&&(r.stylings.randomStartIndex=n)}else(e.startsWith("dp:")||e.startsWith("display:"))&&(r.stylings.display=e.match(i)[1])})});const c=[],a=new RegExp("^\\^(?:apply|app|a)\\("+`(${n})`+"(?:\\s*,\\s(?:(\\d+)|(n-\\d+)|((?:\\+|-)\\d+)|"+`(${n})(?::(\\d+|n?-\\d+))?`+"))?\\)$");return e.flat().map(e=>[...e,e[2].match(a)]).filter(e=>e[3]).forEach(t=>{const[n,l,i,a,d,f,u]=t[3];o.find(e=>e.name===l)&&s(e,r,i,a,t[0],d,f,u).forEach(e=>c[e]=l)}),[o,c]}(d,r,m),[E,M]=f(t,m);u(M,p),h(M,E),y(g,E);const b=E.map(e=>e.filter(e=>"d"!==e[3])),v=o(b,[])[0].map((e,n)=>({name:e.name,elements:e.elements,lastMinute:t[n].lastMinute})),[I,S]=f(v,m);u(S,p.filter(e=>e.lastMinute)),h(S.filter(e=>e.lastMinute),I);const _=a.renderSets(function(e,t){const n=Array(t.length);for(const[s,r]of t.map((e,t)=>({rendering:e,order:t})).entries()){const t=e.find(e=>s===e.to);t?n[t.from]=r:n.push(r)}return n.filter(e=>void 0!==e)}([],I),$,x,{},t);Persistence.removeItem("SRdata"),Persistence.setItem("SRdata",[d,e,r,c||[],M||[],S||[],_||[]])}}()}();
