!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function t(e,t){const n=[];for(const r of t){const t=e[r];t&&n.push(t)}if(t.length<e.length)for(const r of Array.from(new Array(e.length-t.length),(e,n)=>n+t.length))n.push(e[r]);return n}function n(e){const t=[],n=new RegExp("^\\^!!?$"),r=new RegExp("^[^\\^]");for(const[o,s]of e.entries()){const e=[];let i=!1;for(const t of s)n.test(t[2])?i=!0:r.test(t[2])&&e.push(t);t.push({name:o,elements:e,lastMinute:i})}return t}function r(e){const t=[],n=new RegExp("^\\^.*!!(?:[a-zA-Z]+\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z]+)!!?(?:[a-zA-Z]+\\?\\??)?$").exec(r[2])){const o=r[0];0===t.filter(t=>t.name===e[1]).length?t.push({name:e[1],lastMinute:!1,sets:[o]}):t.filter(t=>t.name===e[1])[0].sets.push(o),n.test(r[2])&&(t.filter(t=>t.name===e[1])[0].lastMinute=!0)}}return t}function o(e,t,n){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?t+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?t-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?n-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function s(e){for(var t,n,r=e.length;0!==r;)n=Math.floor(Math.random()*r),t=e[r-=1],e[r]=e[n],e[n]=t;return e}function i(e){return e.map(e=>({name:e.name,length:e.elements.length,order:s([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function a(e,t){return e.map(e=>{const n=e.sets.map(e=>t.filter(t=>t.name===e)).map(e=>e[0].elements.length),r=n.reduce((e,t)=>e+t,0);return{name:e.name,length:r,sets:e.sets,setLengths:n,order:s([...new Array(r).keys()]),lastMinute:e.lastMinute}})}function c(e,n,r,o){const s=e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"])),c=JSON.parse(JSON.stringify(s)),l=[i(e),a(n,e)].flat();return r.forEach(e=>(function(e,t){const n=function(e,t){return e.sets.map(e=>({name:e,length:t.filter(t=>t.name===e)[0].length})).reduce((e,t)=>e.length<t.length?t:e).name}(e,t),r=t.filter(e=>e.name===n)[0].order;for(const n of e.sets){const e=t.filter(e=>e.name===n)[0].order,o=r.filter(t=>t<e.length);t.forEach(e=>{e.name===n&&(e.order=o)})}return t})(e,l)),l.filter(e=>e.lastMinute||!o).forEach(e=>(function(e,n,r){switch(typeof e.name){case"number":const o=r[e.name];n[e.name]=t(o,e.order);break;case"string":(function(e,t){const n=[];let r=0;for(const o of t)n.push(e.slice(r,r+o)),r+=o;return n})(t(e.sets.map(e=>r[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}})(e,c,s)),[c,l]}window.Persistence&&Persistence.isAvailable()&&(Persistence.removeItem("AnkiSetRandomizerOptions"),Persistence.removeItem("AnkiSetRandomizerNewRandomization"),Persistence.removeItem("AnkiSetRandomizerLastMinuteRandomization"));const l={query:$$query,colors:$$colors,fieldPadding:$$field_padding,inputSyntax:{openDelim:$$input_syntax_open_delim,closeDelim:$$input_syntax_close_delim,fieldSeparator:$$input_syntax_field_separator},outputSyntax:{openDelim:$$output_syntax_open_delim,closeDelim:$$output_syntax_close_delim,fieldSeparator:$$output_syntax_field_separator}},u=function(t){let n;const r=function(){if(n)return n;{const r=RegExp(`(?:${e(t.inputSyntax.openDelim)})(.*?)(?:${e(t.inputSyntax.closeDelim)})`,"gm"),o=document.querySelector(t.query),s=o?o.innerHTML:"",i=[];let a=r.exec(s);for(;a;)i.push(a[1]),a=r.exec(s);return n=i}};return{getRawStructure:r,getOriginalStructure:function(){const e=[];for(const[n,o]of r().entries())e.push(o.split(t.inputSyntax.fieldSeparator).map((e,t)=>[n,t,e]));return e},renderSets:function(e){const n=[];for(const r of e){const e=[],o=0;for(const[n,s]of r.entries())if("d"!==s[3]){const r=(o+n)%t.colors.length,i=`style="color: ${t.colors[r]}; padding: 0px ${t.fieldPadding};"`;e.push(`<span ${i}> ${s[2]}</span>`)}n.push(e.join(t.outputSyntax.fieldSeparator))}const o=document.querySelector(t.query);let s=o?o.innerHTML:"";for(const[e,o]of r().entries())s=s.replace(`${t.inputSyntax.openDelim}${o}${t.inputSyntax.closeDelim}`,`${t.outputSyntax.openDelim}${n[e]}${t.outputSyntax.closeDelim}`);document.querySelector(t.query).innerHTML=s}}}(l),f=u.getOriginalStructure();if(f){const e=n(f),t=r(f),s=r(f),[i,a]=c(e,t,s,!1),l=function(e){const t=[],n="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z]+)",r=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?=(?:(\\d+))?$`,s=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?\\~(?:(\\d+))?$`,i=`^\\^${n}(?::(\\d+|n(?:-\\d+)?))?%(?:(\\d+))?$`;for(const n of e)for(const a of n){const c=a[0],l=a[1];let u,f;if((u=new RegExp(r,"gm").exec(a[2]))?f="c":(u=new RegExp(s,"gm").exec(a[2]))?f="m":(u=new RegExp(i,"gm").exec(a[2]))&&(f="d"),f){const r=o(u[1],c,e.length),s=o(u[2]||0,l,n.length),i=Number(u[3])||999;t.push([c,l,f,r,s,i])}}return t}(f).reverse();[l.filter(e=>"m"===e[2]),l.filter(e=>"c"===e[2]),l.filter(e=>"d"===e[2])].flat().forEach(e=>(function(e,t){const n=t[e[3]].filter(e=>"n"===e[3]).slice(e[4],e[4]+e[5]);"d"!==e[2]&&"m"!==e[2]||t[e[3]].splice(e[4],e[5],...n.map(e=>[e[0],e[1],e[2],"d"])),"c"!==e[2]&&"m"!==e[2]||t[e[0]].splice(e[1],0,...n.map(t=>[t[0],t[1],t[2],e[2]]))})(e,i));const m=n(i.map(e=>e.filter(e=>"d"!==e[3]))).map((t,n)=>({name:t.name,elements:t.elements,lastMinute:e[n].lastMinute})),[p,d]=c(m,t,s.filter(e=>e.lastMinute),!0);u.renderSets(p)}l&&window.Persistence&&Persistence.isAvailable()&&Persistence.setItem("AnkiSetRandomizerOptions",l)}();
