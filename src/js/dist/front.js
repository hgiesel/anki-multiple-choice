!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function n(e,n){const t=[],r=[],o=new RegExp("^\\^!!?$"),s=new RegExp("^[^\\^]");for(const[c,l]of e.entries()){const e=[];let u=!1;for(const t of l){let c;if(o.test(t[2]))u=!0;else if(c=new RegExp("^\\^(\\d+(?:\\.\\d*)?),(\\d+(?:\\.\\d*)?)(?:,(\\d+))?#$","gm").exec(t[2])){const o=t[0],s=t[1];let l;const u=n.find(e=>e[0]===o&&e[1]===s);if(u)l=u;else{const e=c[1],n=c[2],t=c[3],r=e.includes(".")||n.includes("."),u=(i=Number(e),a=Number(n),Math.random()*(a-i)+i),m=r?u.toFixed(t||2):(Math.round(u)*(t||1)).toString();l=[o,s,m]}r.push(l),e.push(l)}else s.test(t[2])&&e.push(t)}t.push({name:c,elements:e,lastMinute:u})}var i,a;return[t,r]}function t(e,n,t){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?n+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?n-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?t-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function r(e,n){const t=[];for(const r of n){const n=e[r];n&&t.push(n)}if(n.length<e.length)for(const r of Array.from(new Array(e.length-n.length),(e,t)=>t+n.length))t.push(e[r]);return t}function o(e,n,t){switch(typeof e.name){case"number":const o=t[e.name];n[e.name]=r(o,e.order);break;case"string":(function(e,n){const t=[];let r=0;for(const o of n)t.push(e.slice(r,r+o)),r+=o;return t})(r(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}}function s(e){for(var n,t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),n=e[r-=1],e[r]=e[t],e[t]=n;return e}function i(e){return e.map(e=>({name:e.name,length:e.elements.length,order:s([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function a(e,n){return e.map(e=>{const t=e.sets.map(e=>n.filter(n=>n.name===e)).map(e=>e[0].elements.length),r=t.reduce((e,n)=>e+n,0);return{name:e.name,length:r,sets:e.sets,setLengths:t,order:s([...new Array(r).keys()]),lastMinute:e.lastMinute}})}function c(e,n,t){const r=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),o=JSON.parse(JSON.stringify(r)),s=[i(e),a(n,e)].flat();return t.forEach(e=>(function(e,n){const t=function(e,n){return e.sets.map(e=>({name:e,length:n.filter(n=>n.name===e)[0].length})).reduce((e,n)=>e.length<n.length?n:e).name}(e,n),r=n.filter(e=>e.name===t)[0].order;for(const t of e.sets){const e=n.filter(e=>e.name===t)[0].order,o=r.filter(n=>n<e.length);n.forEach(e=>{e.name===t&&(e.order=o)})}return n})(e,s)),[r,o,s]}window.Persistence&&Persistence.isAvailable()&&function(){const r={query:$$query,colors:$$colors,colors_collective_indexing:$$colors_collective_indexing,colors_random_start_index:$$colors_random_start_index,fieldPadding:$$field_padding,inputSyntax:{openDelim:$$input_syntax_open_delim,closeDelim:$$input_syntax_close_delim,fieldSeparator:$$input_syntax_field_separator},outputSyntax:{openDelim:$$output_syntax_open_delim,closeDelim:$$output_syntax_close_delim,fieldSeparator:$$output_syntax_field_separator}},s=document.querySelector(r.query);if(!s||!s.innerHTML||s.innerHTML.includes("SET RANDOMIZER FRONT TEMPLATE")||s.innerHTML.includes("SET RANDOMIZER BACK TEMPLATE"))return;const i=function(n){let t={};const r=`${e(n.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(n.inputSyntax.closeDelim)}`,o=function(e=n.query){if(t[e])return t[e];{const n=document.querySelector(e),o=n?n.innerHTML:"",s=[],i=RegExp(r,"gm");let a=i.exec(o);for(;a;)s.push(a[1]),a=i.exec(o);return t[e]=s}},s=function(e=n.query){const t=[];for(const[r,s]of o(e).entries()){const e=s.split(n.inputSyntax.fieldSeparator).map((e,n)=>[r,n,e]);t.push(e)}return t},i=function(e,t,r=n.query){let a=0+(n.colors_random_start_index?Math.floor((t[0]||Math.random())*n.colors.length):0);const c=Array(e.length);for(const[r,o]of e.entries()){const e=[],s=n.colors_random_start_index?Math.floor((t[r]||Math.random())*n.colors.length):0;for(const[t,r]of o.rendering.entries())if("d"!==r[3]){const o=(n.colors_collective_indexing?a++:s+t)%n.colors.length,i=`class="set-randomizer--element set-randomizer--element-index-${r[0]}-${r[1]}"`,c=n.colors[o]?` color: ${n.colors[o]};`:"",l=`style="padding: 0px ${n.fieldPadding}px;${c}"`;e.push(`<span ${i} ${l}>${r[2]}</span>`)}c[o.order]=e.join(n.outputSyntax.fieldSeparator)}const l=document.querySelector(r);let u=l?l.innerHTML:"";for(const[e,t]of o(r).entries())u=u.replace(`${n.inputSyntax.openDelim}${t}${n.inputSyntax.closeDelim}`,`${n.outputSyntax.openDelim}${c[e]}${n.outputSyntax.closeDelim}`);if(document.querySelector(r).innerHTML=u,"div#clozed"===r){const n=s("div#original").flat();if(n.length>0){const r=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],n.find(n=>n[0]===e[0]&&n[1]===e[1])[2],e[3]]),order:e.order}));i(r,t,"div#original")}}};return{getOriginalStructure:s,renderSets:i}}(r),a=i.getOriginalStructure();if(a){const[e,s]=n(a,[]),l=function(e){const n=[],t=new RegExp("^\\^.*!!(?:[a-zA-Z_][a-zA-Z0-9_]*\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z_][a-zA-Z0-9_]*)!!?(?:[a-zA-Z_][a-zA-Z0-9_]*\\?\\??)?$").exec(r[2])){const o=r[0];0===n.filter(n=>n.name===e[1]).length?n.push({name:e[1],lastMinute:!1,sets:[o]}):n.filter(n=>n.name===e[1])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(a),u=function(e){const n=[],t=new RegExp("^\\^.*\\?\\?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^(?:([a-zA-Z_][a-zA-Z0-9_]*)!!?)?([a-zA-Z_][a-zA-Z0-9_]*)\\?$").exec(r[2])){const o=e[1]||r[0];0===n.filter(n=>n.name===e[2]).length?n.push({name:e[2],sets:[o]}):n.filter(n=>n.name===e[2])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(a),[m,d,f]=c(e,l,u);f.forEach(e=>o(e,m,d));const p=function(e){const n=[],r="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z_][a-zA-Z0-9_]*)",o=`^\\^${r}(?::(\\d+|n(?:-\\d+)?))?,(?:(\\d+))?=$`,s=`^\\^${r}(?::(\\d+|n(?:-\\d+)?))?,(?:(\\d+))?\\~$`;for(const r of e)for(const i of r){const a=i[0],c=i[1];let l,u;if((l=new RegExp(o,"gm").exec(i[2]))?u="c":(l=new RegExp(s,"gm").exec(i[2]))?u="m":(l=new RegExp("^\\^(?:(\\d+))?\\%$","gm").exec(i[2]))&&(u="d"),"c"===u||"m"===u){const o=t(l[1],a,e.length),s=t(l[2]||0,c,r.length),i=Number(l[3])||999;n.push([o,s,i,u,a,c])}else if("d"===u){const e=a,t=c,r=Number(l[1])||999;n.push([e,t,r,u,a,c])}}return n}(a),g=p.reverse(),h=[g.filter(e=>"m"===e[3]),g.filter(e=>"c"===e[3]),g.filter(e=>"d"===e[3])].flat();h.forEach(e=>(function(e,n){const t=[];for(const r of n[e[0]])if("d"!==r[3]&&(t.push(r.map(e=>e)),"dm".includes(e[3])&&(r[3]="d"),0==--e[2]))break;t.forEach(e=>e.splice(3,1,"c")),"cm".includes(e[3])&&n[e[4]].splice(e[5],0,...t)})(e,m));const $=m.map(e=>e.filter(e=>"d"!==e[3])),x=n($,[])[0].map((n,t)=>({name:n.name,elements:n.elements,lastMinute:e[t].lastMinute})),[_,S,R]=c(x,l,u.filter(e=>e.lastMinute));R.filter(e=>e.lastMinute).forEach(e=>o(e,_,S));const y=new Array(_.length).fill(0).map(e=>Math.random());i.renderSets(_.map((e,n)=>({rendering:e,order:n})),y),Persistence.removeItem("AnkiSetRandomizerOriginalStructure"),Persistence.removeItem("AnkiSetRandomizerOptions"),Persistence.removeItem("AnkiSetRandomizerGeneratorValues"),Persistence.removeItem("AnkiSetRandomizerNewReorders"),Persistence.removeItem("AnkiSetRandomizerLastMinuteReorders"),Persistence.removeItem("AnkiSetRandomizerRandomIndices"),Persistence.setItem("AnkiSetRandomizerOptions",r),Persistence.setItem("AnkiSetRandomizerOriginalStructure",a),Persistence.setItem("AnkiSetRandomizerGeneratorValues",s||[]),Persistence.setItem("AnkiSetRandomizerNewReorders",f||[]),Persistence.setItem("AnkiSetRandomizerLastMinuteReorders",R||[]),Persistence.setItem("AnkiSetRandomizerRandomIndices",y||[])}}()}();
