!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function n(e,n){const t=[],r=[],o=new RegExp("^\\^([a-zA-Z_]\\w*)\\[(.*)\\]$"),s=[];for(const[n,t]of e.entries())for(const e of t){let n;(n=e[2].match(o))&&s.push({name:n[1],elements:n[2].substr(1,n[2].length-2).split(new RegExp("['\"],[\"']"))})}const i=new RegExp("^\\^!!?$"),a=new RegExp("^[^\\^]"),c=[];for(const[o,m]of e.entries()){const e=[];let d=!1;for(const t of m){let o;if(i.test(t[2]))d=!0;else if(o=new RegExp("^\\^(?:[a-zA-Z_]\\w*\\$)?(\\d+(?:\\.\\d*)?,\\d+(?:\\.\\d*)?(?:,\\d+)?|[a-zA-Z_]\\w*)#$","gm").exec(t[2])){const i=o[0].match(RegExp("^\\^([a-zA-Z_]\\w*)\\$"));let a;i&&(a=i[1]),c.find(e=>e.name===a)||c.push({name:a,values:[]});const m=t[0],d=t[1];let f;const p=n.find(e=>e[0]===m&&e[1]===d);if(p)f=p;else if(/^\d/.test(o[1])){const e=o[1].match(RegExp("(\\d+(?:\\.\\d*)?),(\\d+(?:\\.\\d*)?)(?:,(\\d+))?")),n=e[1],t=e[2],r=e[3],s=n.includes(".")||t.includes(".");let i,p=!1,g=0;const h=1e3;for(;!p&&g<h;){const e=(l=Number(n),u=Number(t),Math.random()*(u-l)+l);i=s?e.toFixed(r||2):(Math.round(e)*(r||1)).toString(),a&&(c.find(e=>e.name===a).values.includes(i)||(p=!0)),g++}g<h&&(f=[m,d,i])}else{const e=o[1],n=s.find(n=>n.name===e);if(n){let e,t=!1,r=0;const o=1e3;for(;!t&&r<o;){const o=Math.floor(Math.random()*n.elements.length);e=n.elements[o],a&&(c.find(e=>e.name===a).values.includes(e)||(t=!0)),r++}r<o&&(f=[m,d,e])}}f&&(a&&c.find(e=>e.name===a).values.push(f[2]),r.push(f),e.push(f))}else a.test(t[2])&&e.push(t)}t.push({name:o,elements:e,lastMinute:d})}var l,u;return[t,r]}function t(e,n,t){let r;return(r=new RegExp("^\\+(\\d+)$").exec(e))?n+Number(r[1]):(r=new RegExp("^-(\\d+)$").exec(e))?n-Number(r[1]):(r=new RegExp("^n(-\\d+)?$").exec(e))?t-(Number(r[1])||0)-1:(r=new RegExp("^\\d+$").exec(e))?Number(e):e}function r(e,n){const t=[];for(const r of n){const n=e[r];n&&t.push(n)}if(n.length<e.length)for(const r of Array.from(new Array(e.length-n.length),(e,t)=>t+n.length))t.push(e[r]);return t}function o(e,n,t){switch(typeof e.name){case"number":const o=t[e.name];n[e.name]=r(o,e.order);break;case"string":(function(e,n){const t=[];let r=0;for(const o of n)t.push(e.slice(r,r+o)),r+=o;return t})(r(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((t,r)=>{n[e.sets[r]]=t})}}function s(e){for(var n,t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),n=e[r-=1],e[r]=e[t],e[t]=n;return e}function i(e){return e.map(e=>({name:e.name,length:e.elements.length,order:s([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function a(e,n){return e.map(e=>{const t=e.sets.map(e=>n.filter(n=>n.name===e)).map(e=>e[0].elements.length),r=t.reduce((e,n)=>e+n,0);return{name:e.name,length:r,sets:e.sets,setLengths:t,order:s([...new Array(r).keys()]),lastMinute:e.lastMinute}})}function c(e,n,t){const r=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),o=JSON.parse(JSON.stringify(r)),s=[i(e),a(n,e)].flat();return t.forEach(e=>(function(e,n){const t=function(e,n){return e.sets.map(e=>({name:e,length:n.find(n=>n.name===e).length})).reduce((e,n)=>e.length<n.length?n:e).name}(e,n),r=n.find(e=>e.name===t).order;for(const t of e.sets){const e=n.find(e=>e.name===t).order,o=r.filter(n=>n<e.length);n.forEach(e=>{e.name===t&&(e.order=o)})}return n})(e,s)),[r,o,s]}window.Persistence&&Persistence.isAvailable()&&function(){const r={query:$$query,colors:$$colors,colors_collective_indexing:$$colors_collective_indexing,colors_random_start_index:$$colors_random_start_index,fieldPadding:$$field_padding,inputSyntax:{openDelim:$$input_syntax_open_delim,closeDelim:$$input_syntax_close_delim,fieldSeparator:$$input_syntax_field_separator},outputSyntax:{openDelim:$$output_syntax_open_delim,closeDelim:$$output_syntax_close_delim,fieldSeparator:$$output_syntax_field_separator,emptySet:$$output_syntax_empty_set}},s=document.querySelector(r.query);if(!s||!s.innerHTML||s.innerHTML.includes("SET RANDOMIZER FRONT TEMPLATE")||s.innerHTML.includes("SET RANDOMIZER BACK TEMPLATE"))return;const i=function(n){let t={};const r=`${e(n.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(n.inputSyntax.closeDelim)}`,o=function(e=n.query){if(t[e])return t[e];{const n=document.querySelector(e),o=n?n.innerHTML:"",s=[],i=RegExp(r,"gm");let a=i.exec(o);for(;a;)s.push(a[1]),a=i.exec(o);return t[e]=s}},s=function(e=n.query){const t=[];for(const[r,s]of o(e).entries()){const e=s.split(n.inputSyntax.fieldSeparator).map((e,n)=>[r,n,e]);t.push(e)}return t},i=function(e,t,r=n.query){let a=0+(n.colors_random_start_index?Math.floor((t[0]||Math.random())*n.colors.length):0);const c=Array(e.length);for(const[r,o]of e.entries()){const e=[],s=n.colors_random_start_index?Math.floor((t[r]||Math.random())*n.colors.length):0;for(const[t,r]of o.rendering.entries())if("d"!==r[3]){const o=(n.colors_collective_indexing?a++:s+t)%n.colors.length,i=`class="set-randomizer--element set-randomizer--element-index-${r[0]}-${r[1]}"`,c=n.colors[o]?` color: ${n.colors[o]};`:"",l=`style="padding: 0px ${n.fieldPadding}px;${c}"`;e.push(`<span ${i} ${l}>${r[2]}</span>`)}c[o.order]=e.join(n.outputSyntax.fieldSeparator)}const l=document.querySelector(r);let u=l?l.innerHTML:"";for(const[e,t]of o(r).entries()){const r=c[e]||n.outputSyntax.emptySet;u=u.replace(`${n.inputSyntax.openDelim}${t}${n.inputSyntax.closeDelim}`,`${n.outputSyntax.openDelim}${r}${n.outputSyntax.closeDelim}`)}if(document.querySelector(r).innerHTML=u,"div#clozed"===r){const n=s("div#original").flat();if(n.length>0){const r=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],n.find(n=>n[0]===e[0]&&n[1]===e[1])[2],e[3]]),order:e.order}));i(r,t,"div#original")}}};return{getOriginalStructure:s,renderSets:i}}(r),a=i.getOriginalStructure();if(a){const[e,s]=n(a,[]),l=function(e){const n=[],t=new RegExp("^\\^.*!!(?:[a-zA-Z_]\\w*\\?\\??)?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^([a-zA-Z_]\\w*)!!?(?:[a-zA-Z_]\\w*\\?\\??)?$").exec(r[2])){const o=r[0];0===n.filter(n=>n.name===e[1]).length?n.push({name:e[1],lastMinute:!1,sets:[o]}):n.filter(n=>n.name===e[1])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(a),u=function(e){const n=[],t=new RegExp("^\\^.*\\?\\?$");for(const r of e.flat()){let e;if(e=new RegExp("^\\^(?:([a-zA-Z_]\\w*)!!?)?([a-zA-Z_]\\w*)\\?$").exec(r[2])){const o=e[1]||r[0];0===n.filter(n=>n.name===e[2]).length?n.push({name:e[2],sets:[o]}):n.filter(n=>n.name===e[2])[0].sets.push(o),t.test(r[2])&&(n.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return n}(a),[m,d,f]=c(e,l,u);f.forEach(e=>o(e,m,d));const p=function(e){const n=[],r="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|[a-zA-Z_]\\w*)",o=`^\\^(?:${r}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?=$`,s=`^\\^(?:${r}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\~$`,i=`^\\^(?:${r}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\%$`;for(const r of e)for(const a of r){const c=a[0],l=a[1];let u,m;if((u=new RegExp(o,"gm").exec(a[2]))?m="c":(u=new RegExp(s,"gm").exec(a[2]))?m="m":(u=new RegExp(i,"gm").exec(a[2]))&&(m="d"),m){const o=t(u[1]||c,c,e.length),s=t(u[2]||0,l,r.length),i=Number(u[3])||999;n.push([o,s,i,m,c,l])}}return n}(a),g=p.reverse(),h=[g.filter(e=>"c"===e[3]),g.filter(e=>"m"===e[3]),g.filter(e=>"d"===e[3])].flat();h.forEach(e=>(function(e,n){const t=[];for(const r of n[e[0]])if("d"!==r[3]&&"c"!==r[3]&&(t.push(r.map(e=>e)),"d"!==e[3]&&"m"!==e[3]||(r[3]="d"),0==--e[2]))break;t.forEach(e=>e.splice(3,1,"c")),"c"!==e[3]&&"m"!==e[3]||n[e[4]].splice(e[5],0,...t)})(e,m));const $=m.map(e=>e.filter(e=>"d"!==e[3])),x=n($,[])[0].map((n,t)=>({name:n.name,elements:n.elements,lastMinute:e[t].lastMinute})),[_,S,y]=c(x,l,u.filter(e=>e.lastMinute));y.filter(e=>e.lastMinute).forEach(e=>o(e,_,S));const R=new Array(_.length).fill(0).map(e=>Math.random());i.renderSets(_.map((e,n)=>({rendering:e,order:n})),R),Persistence.removeItem("AnkiSetRandomizerOriginalStructure"),Persistence.removeItem("AnkiSetRandomizerOptions"),Persistence.removeItem("AnkiSetRandomizerGeneratorValues"),Persistence.removeItem("AnkiSetRandomizerNewReorders"),Persistence.removeItem("AnkiSetRandomizerLastMinuteReorders"),Persistence.removeItem("AnkiSetRandomizerRandomIndices"),Persistence.setItem("AnkiSetRandomizerOptions",r),Persistence.setItem("AnkiSetRandomizerOriginalStructure",a),Persistence.setItem("AnkiSetRandomizerGeneratorValues",s||[]),Persistence.setItem("AnkiSetRandomizerNewReorders",f||[]),Persistence.setItem("AnkiSetRandomizerLastMinuteReorders",y||[]),Persistence.setItem("AnkiSetRandomizerRandomIndices",R||[])}}()}();
