!function(){"use strict";function e(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}const n="[a-zA-Z_]\\w*";function t(e,t){const s=[],r=[],o=new RegExp(`^\\^(${n})\\[(.*)\\]$`),i=[];for(const[n,t]of e.entries())for(const e of t){let n;(n=e[2].match(o))&&i.push({name:n[1],elements:n[2].substr(1,n[2].length-2).split(new RegExp("['\"],[\"']"))})}const a=new RegExp("^\\^!!?$"),c=`^\\^(?:${n}\\$)?(\\d+(?:\\.\\d*)?,\\d+(?:\\.\\d*)?(?:,\\d+)?|${n})#$`,l=`^\\^(${n})\\$`,m=new RegExp("^[^\\^]"),d=[];for(const[n,o]of e.entries()){const e=[];let p=!1;for(const n of o){let s;if(a.test(n[2]))p=!0;else if(s=new RegExp(c,"gm").exec(n[2])){const o=s[0].match(RegExp(l));let a;o&&(a=o[1]),d.find(e=>e.name===a)||d.push({name:a,values:[]});const c=n[0],m=n[1];let p;const g=t.find(e=>e[0]===c&&e[1]===m);if(g)p=g;else if(/^\d/.test(s[1])){const e=s[1].match(RegExp("(\\d+(?:\\.\\d*)?),(\\d+(?:\\.\\d*)?)(?:,(\\d+))?")),n=e[1],t=e[2],r=e[3],o=n.includes(".")||t.includes(".");let i,l=!1,g=0;const h=1e3;for(;!l&&g<h;){const e=(u=Number(n),f=Number(t),Math.random()*(f-u)+u);i=o?e.toFixed(r||2):(Math.round(e)*(r||1)).toString(),a&&(d.find(e=>e.name===a).values.includes(i)||(l=!0)),g++}g<h&&(p=[c,m,i])}else{const e=s[1],n=i.find(n=>n.name===e);if(n){let e,t=!1,s=0;const r=1e3;for(;!t&&s<r;){const r=Math.floor(Math.random()*n.elements.length);e=n.elements[r],a&&(d.find(e=>e.name===a).values.includes(e)||(t=!0)),s++}s<r&&(p=[c,m,e])}}p&&(a&&d.find(e=>e.name===a).values.push(p[2]),r.push(p),e.push(p))}else m.test(n[2])&&e.push(n)}s.push({name:n,elements:e,lastMinute:p})}var u,f;return[s,r]}function s(e,n,t){let s;return(s=new RegExp("^\\+(\\d+)$").exec(e))?n+Number(s[1]):(s=new RegExp("^-(\\d+)$").exec(e))?n-Number(s[1]):(s=new RegExp("^n(-\\d+)?$").exec(e))?t-(Number(s[1])||0)-1:(s=new RegExp("^\\d+$").exec(e))?Number(e):e}function r(e,n){const t=[];for(const s of n){const n=e[s];n&&t.push(n)}if(n.length<e.length)for(const s of Array.from(new Array(e.length-n.length),(e,t)=>t+n.length))t.push(e[s]);return t}function o(e,n,t){switch(typeof e.name){case"number":const s=t[e.name];n[e.name]=r(s,e.order);break;case"string":(function(e,n){const t=[];let s=0;for(const r of n)t.push(e.slice(s,s+r)),s+=r;return t})(r(e.sets.map(e=>t[e]).flat(),e.order),e.setLengths).forEach((t,s)=>{n[e.sets[s]]=t})}}function i(e){for(var n,t,s=e.length;0!==s;)t=Math.floor(Math.random()*s),n=e[s-=1],e[s]=e[t],e[t]=n;return e}function a(e){return e.map(e=>({name:e.name,length:e.elements.length,order:i([...new Array(e.elements.length).keys()]),lastMinute:e.lastMinute}))}function c(e,n){return e.map(e=>{const t=e.sets.map(e=>n.filter(n=>n.name===e)).map(e=>e[0].elements.length),s=t.reduce((e,n)=>e+n,0);return{name:e.name,length:s,sets:e.sets,setLengths:t,order:i([...new Array(s).keys()]),lastMinute:e.lastMinute}})}function l(e,n,t){const s=function(e){return e.map(e=>e.elements).map(e=>e.map(e=>[e[0],e[1],e[2],"n"]))}(e),r=JSON.parse(JSON.stringify(s)),o=[a(e),c(n,e)].flat();return t.forEach(e=>(function(e,n){const t=function(e,n){return e.sets.map(e=>({name:e,length:n.find(n=>n.name===e).length})).reduce((e,n)=>e.length<n.length?n:e).name}(e,n),s=n.find(e=>e.name===t).order;for(const t of e.sets){const e=n.find(e=>e.name===t).order,r=s.filter(n=>n<e.length);n.forEach(e=>{e.name===t&&(e.order=r)})}return n})(e,o)),[s,r,o]}window.Persistence&&Persistence.isAvailable()&&function(){const r={query:$$query,colors:$$colors,colors_collective_indexing:$$colors_collective_indexing,colors_random_start_index:$$colors_random_start_index,fieldPadding:$$field_padding,inputSyntax:{openDelim:$$input_syntax_open_delim,closeDelim:$$input_syntax_close_delim,fieldSeparator:$$input_syntax_field_separator},outputSyntax:{openDelim:$$output_syntax_open_delim,closeDelim:$$output_syntax_close_delim,fieldSeparator:$$output_syntax_field_separator,emptySet:$$output_syntax_empty_set}},i=document.querySelector(r.query);if(!i||!i.innerHTML||i.innerHTML.includes("SET RANDOMIZER FRONT TEMPLATE")||i.innerHTML.includes("SET RANDOMIZER BACK TEMPLATE"))return;const a=function(n){let t={};const s=`${e(n.inputSyntax.openDelim)}(?:::)?(.*?)(?:::)?${e(n.inputSyntax.closeDelim)}`,r=function(e=n.query){if(t[e])return t[e];{const n=document.querySelector(e),r=n?n.innerHTML:"",o=[],i=RegExp(s,"gm");let a=i.exec(r);for(;a;)o.push(a[1]),a=i.exec(r);return t[e]=o}},o=function(e=n.query){const t=[];for(const[s,o]of r(e).entries()){const e=o.split(n.inputSyntax.fieldSeparator).map((e,n)=>[s,n,e]);t.push(e)}return t},i=function(e,t,s,a=n.query){let c=0+(n.colors_random_start_index?Math.floor((s[0]||Math.random())*n.colors.length):0),l=0;const m=Array(e.length);for(const[r,o]of e.entries()){const e=t.find(e=>e.name===r).directives;let i;void 0===e.colors?i=n.colors:(i=e.colors,l=c,c=0);const a=void 0===e.fieldSeparator?n.outputSyntax.fieldSeparator:e.fieldSeparator,d=void 0===e.fieldPadding?n.fieldPadding:e.fieldPadding,u=void 0===e.closeDelim?n.outputSyntax.closeDelim:e.closeDelim,f=void 0===e.openDelim?n.outputSyntax.openDelim:e.openDelim,p=[],g=n.colors_random_start_index?Math.floor((s[r]||Math.random())*i.length):0;for(const[e,t]of o.rendering.entries())if("d"!==t[3]){const s=(n.colors_collective_indexing?c++:g+e)%i.length,r=`class="set-randomizer--element set-randomizer--element-index-${t[0]}-${t[1]}"`,o=`style="padding: 0px ${d}px;${i[s]?` color: ${i[s]};`:""}"`;p.push(`<span ${r} ${o}>${t[2]}</span>`)}p.length>0?m[o.order]=`${f}${p.join(a)}${u}`:m[o.order]=`${f}${n.outputSyntax.emptySet}${u}`,void 0!==e.colors&&(c=l)}const d=document.querySelector(a);let u=d?d.innerHTML:"";for(const[e,t]of r(a).entries()){const s=m[e];u=u.replace(`${n.inputSyntax.openDelim}${t}${n.inputSyntax.closeDelim}`,`${s}`)}if(document.querySelector(a).innerHTML=u,"div#clozed"===a){const n=o("div#original").flat();if(n.length>0){const r=e.map(e=>({rendering:e.rendering.map(e=>[e[0],e[1],n.find(n=>n[0]===e[0]&&n[1]===e[1])[2],e[3]]),order:e.order}));i(r,t,s,"div#original")}}};return{getOriginalStructure:o,renderSets:i}}(r),c=a.getOriginalStructure();if(c){const[e,i]=t(c,[]),m=function(e){const t=[],s=`${n}\\?\\?`,r=`^\\^(${n})!!?(?:${s}|${`(?:${n}\\+)?(?:([a-zA-Z]+),.*?@)*$`})?$`,o=new RegExp(`^\\^.*!!${s}$`);for(const n of e.flat()){let e;if(e=new RegExp(r).exec(n[2])){const s=n[0];0===t.filter(n=>n.name===e[1]).length?t.push({name:e[1],lastMinute:!1,sets:[s]}):t.filter(n=>n.name===e[1])[0].sets.push(s),o.test(n[2])&&(t.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return t}(c),d=function(e){const t=[],s=`^\\^${`(?:(${n})!!?)?`}(${n})\\?$`,r=new RegExp("^\\^.*\\?\\?$");for(const n of e.flat()){let e;if(e=new RegExp(s).exec(n[2])){const s=e[1]||n[0];0===t.filter(n=>n.name===e[2]).length?t.push({name:e[2],sets:[s]}):t.filter(n=>n.name===e[2])[0].sets.push(s),r.test(n[2])&&(t.filter(n=>n.name===e[1])[0].lastMinute=!0)}}return t}(c),u=function(e,t){const s=[],r=`^\\^(?:(?:(${n})!)?(${n})\\+)?((?:[a-zA-Z]+,.*?@)*)$`,o=[],i=[];for(const[n,a]of e.entries()){s.push({name:n,directives:{}});for(const e of a){let s;if(s=e[2].match(r)){const e=s[1],r=s[2];r&&(o.find(e=>e.name===r)||o.push({name:r,sets:[]}),e?o.find(e=>e.name===r).sets.push(...t.find(n=>n.name===e).sets):o.find(e=>e.name===r).sets.push(n));const a=s[3].split("@").slice(0,-1);a.length>0&&i.push({name:r||n,assignments:a.map(e=>[e.split(",",1)[0],e.split(/^.*?,/)[1]])})}}}for(const e of i.sort((e,n)=>"number"==typeof e.name?1:-1)){const n=[];for(const t of e.assignments)switch(t[0]){case"openDelim":case"od":n.push({name:"openDelim",value:t[1]});break;case"closeDelim":case"cd":n.push({name:"closeDelim",value:t[1]});break;case"fieldSeparator":case"fs":n.push({name:"fieldSeparator",value:t[1]});break;case"fieldPadding":case"fp":const e=Number(t[1]);e&&n.push({name:"fieldPadding",value:e});break;case"colors":case"clrs":n.push({name:"colors",value:t[1].split(",")})}const t=function(e,n){switch(typeof e){case"number":for(const t of n)s.find(n=>n.name===e).directives[t.name]=t.value;break;case"string":for(const s of o.find(n=>n.name===e).sets)t(s,n)}};t(e.name,n)}return s}(c,m),[f,p,g]=l(e,m,d);g.forEach(e=>o(e,f,p));const h=function(e){const n=[],t="(\\d+|\\+\\d+|\\-\\d+|n(?:-\\d+)?|${namePattern})",r=`^\\^(?:${t}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?=$`,o=`^\\^(?:${t}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\~$`,i=`^\\^(?:${t}(?::(\\d+|n(?:-\\d+)?))?(?:,(\\d+))?)?\\%$`;for(const t of e)for(const a of t){const c=a[0],l=a[1];let m,d;if((m=new RegExp(r,"gm").exec(a[2]))?d="c":(m=new RegExp(o,"gm").exec(a[2]))?d="m":(m=new RegExp(i,"gm").exec(a[2]))&&(d="d"),d){const r=s(m[1]||c,c,e.length),o=s(m[2]||0,l,t.length),i=Number(m[3])||999;n.push([r,o,i,d,c,l])}}return n}(c),$=h.reverse(),x=[$.filter(e=>"c"===e[3]),$.filter(e=>"m"===e[3]),$.filter(e=>"d"===e[3])].flat();x.forEach(e=>(function(e,n){const t=[];for(const s of n[e[0]])if("d"!==s[3]&&"c"!==s[3]&&(t.push(s.map(e=>e)),"d"!==e[3]&&"m"!==e[3]||(s[3]="d"),0==--e[2]))break;t.forEach(e=>e.splice(3,1,"c")),"c"!==e[3]&&"m"!==e[3]||n[e[4]].splice(e[5],0,...t)})(e,f));const S=f.map(e=>e.filter(e=>"d"!==e[3])),y=t(S,[])[0].map((n,t)=>({name:n.name,elements:n.elements,lastMinute:e[t].lastMinute})),[R,_,v]=l(y,m,d.filter(e=>e.lastMinute));v.filter(e=>e.lastMinute).forEach(e=>o(e,R,_));const M=new Array(R.length).fill(0).map(e=>Math.random());a.renderSets(R.map((e,n)=>({rendering:e,order:n})),u,M),Persistence.removeItem("AnkiSetRandomizerOriginalStructure"),Persistence.removeItem("AnkiSetRandomizerOptions"),Persistence.removeItem("AnkiSetRandomizerGeneratorValues"),Persistence.removeItem("AnkiSetRandomizerNewReorders"),Persistence.removeItem("AnkiSetRandomizerLastMinuteReorders"),Persistence.removeItem("AnkiSetRandomizerRandomIndices"),Persistence.setItem("AnkiSetRandomizerOptions",r),Persistence.setItem("AnkiSetRandomizerOriginalStructure",c),Persistence.setItem("AnkiSetRandomizerGeneratorValues",i||[]),Persistence.setItem("AnkiSetRandomizerNewReorders",g||[]),Persistence.setItem("AnkiSetRandomizerLastMinuteReorders",v||[]),Persistence.setItem("AnkiSetRandomizerRandomIndices",M||[])}}()}();
